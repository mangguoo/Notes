## å¾®ä¿¡å…¬ä¼—å¹³å°æ¦‚è¿°

### å¾®ä¿¡å…¬ä¼—å¹³å°ä»‹ç»

> å¾®ä¿¡å…¬ä¼—å·æ˜¯å¼€å‘è€…æˆ–å•†å®¶åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ä¸Šç”³è¯·çš„åº”ç”¨è´¦å·ï¼Œé€šè¿‡å…¬ä¼—å¹³å°ï¼Œå•†å®¶å¯åœ¨å¾®ä¿¡å¹³å°ä¸Šå®ç°å’Œç‰¹å®šç¾¤ä½“çš„æ–‡å­—ã€å›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘çš„å…¨æ–¹ä½æ²Ÿé€šã€äº’åŠ¨ã€‚å½¢æˆäº†ä¸€ç§ä¸»æµçš„çº¿ä¸Šçº¿ä¸‹å¾®ä¿¡äº’åŠ¨è¥é”€æ–¹å¼ã€‚
>
> å…¬ä¼—å·è®¤è¯ä¸€æ¬¡éœ€è¦300å…ƒäººæ°‘å¸ï¼Œæ¯å¹´éƒ½éœ€è¦è®¤è¯ä¸€æ¬¡ã€‚åœ¨å…¬å¸å¼€å‘ä¸šåŠ¡éƒ½è¦è®¤è¯ï¼Œè®¤è¯åå…¬ä¼—å·å¹³å°ä¼šç»™ä½ å¼€é€šæ›´å¤šçš„æƒé™ã€‚
>
> å¾®ä¿¡å…¬ä¼—å¹³å°ï¼šhttps://mp.weixin.qq.com

### å¾®ä¿¡å…¬ä¼—å¹³å°çš„ç±»å‹

> è®¢é˜…å·å¯ä»¥ä¸ªäººå’Œä¼ä¸šç»„ç»‡éƒ½å¯ä»¥ç”³è¯·ï¼Œè€Œåä¸¤è€…åªèƒ½æ˜¯ä¼ä¸šæˆ–ç»„ç»‡æ‰å¯ä»¥ç”³è¯·ï¼Œè®¢é˜…å·æ¶ˆæ¯çš„æ˜¾ç¤ºåœ¨â€œ**è®¢é˜…å·**â€æ–‡ä»¶å¤¹ä¸­ï¼Œè€Œåä¸¤è€…ç›´æ¥æ˜¾ç¤ºåœ¨å¥½å‹å¯¹è¯åˆ—è¡¨ä¸­ï¼Œè®¢é˜…å·æ¯å¤©éƒ½å¯ä»¥ç¾¤å‘1æ¡æ¶ˆæ¯ï¼ŒæœåŠ¡å·1ä¸ªæœˆå¯ä»¥ç¾¤å‘4æ¡æ¶ˆæ¯ï¼Œä¼ä¸šå¾®ä¿¡æ²¡æœ‰æ­¤é¡¹åŠŸèƒ½ã€‚

- è®¢é˜…å·ï¼šç”¨äºæœåŠ¡ç±»åŠŸèƒ½

- æœåŠ¡å·ï¼šç”¨äºèµ„è®¯æˆ–æ¨å¹¿

- ä¼ä¸šå¾®ä¿¡ï¼šç”¨äºä¼ä¸šå†…éƒ¨

### å¾®ä¿¡å…¬ä¼—å¹³å°çš„ä¸¤ç§è¿è¡Œæ¨¡å¼

#### ç¼–è¾‘æ¨¡å¼

> ä½¿ç”¨å¾®ä¿¡å…¬ä¼—å·æä¾›çš„ç»Ÿä¸€çš„å¾®ä¿¡å…¬ä¼—ç®¡ç†å¹³å°ï¼Œè¿›è¡Œæ“ä½œã€‚æ‰€æœ‰åŠŸèƒ½éƒ½å·²ç»å†™å¥½ï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚åªéœ€è¦ç¼–è¾‘ç›¸å…³å†…å®¹ä¿¡æ¯ã€‚é€‚åˆä¸ä¼šç¼–ç¨‹çš„äººä½¿ç”¨ã€‚ä¸€èˆ¬ä¼ä¸šä¸ç”¨ã€‚

#### å¼€å‘è€…æ¨¡å¼

> å¾®ä¿¡å…¬ä¼—å¹³å°æä¾›äº†**æœåŠ¡å™¨(å¼€å‘è€…æœåŠ¡å™¨)**æ¥å…¥çš„æ–¹å¼ï¼Œå…·æœ‰å¼€å‘èƒ½åŠ›çš„è¿è¥è€…ï¼Œå¯ä»¥è¿›è¡Œå®šåˆ¶å¼€å‘ã€‚
>
> å¼€å‘è€…æ¨¡å¼:éœ€è¦ä¸€å°æˆ–å¤šå°å¤–ç½‘èƒ½è®¿é—®åˆ°çš„æœåŠ¡å™¨ (éœ€è¦å¤–ç½‘æœåŠ¡å™¨è¿è¡Œ[ä¸Šçº¿])
>
> æ³¨æ„ï¼šå¾®ä¿¡å…¬ä¼—å¹³å°ç®¡ç†ä¸­ï¼Œç¼–è¾‘æ¨¡å¼å’Œå¼€å‘è€…æ¨¡å¼æ˜¯**äº’æ–¥**çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€ç§ã€‚

**å¼€å‘è€…æ¨¡å¼æœ‰2ç§è¯·æ±‚æ–¹å¼ï¼š(è¢«åŠ¨è¯·æ±‚å’Œä¸»åŠ¨è¯·æ±‚)**

- è¢«åŠ¨è¯·æ±‚ï¼š

<img src="https://cdn.jsdelivr.net/gh/ilmangoi/imgRepo@main/img/%E8%BF%90%E8%90%A5%E6%88%90%E6%9C%AC%E5%90%89%E6%A0%BC%E6%96%AFf.png" alt="è¿è¥æˆæœ¬å‰æ ¼æ–¯f" style="zoom:50%;" />

- ä¸»åŠ¨è¯·æ±‚ï¼š

<img src="https://cdn.jsdelivr.net/gh/ilmangoi/imgRepo@main/img/2.png" alt="2" style="zoom:50%;" />

## å¼€å‘å…¬ä¼—å·å‡†å¤‡

> å› ä¸ºåœ¨å¼€å‘æ¨¡å¼ä¸‹é¢ï¼Œéœ€è¦ä¸€æˆ–Nå°å¤–ç½‘æœåŠ¡å™¨ï¼Œç»™å¾®ä¿¡å…¬ä¼—å¹³å°æœåŠ¡å™¨èƒ½è®¿é—®åˆ°ï¼Œå¯ä»¥ä½¿ç”¨äº‘ä¸»æœºæˆ–å…¬å¸æœºæˆ¿å®ä½“æœºï¼Œä½†æ˜¯åœ¨å¼€å‘æˆ–å­¦ä¹ é˜¶æ®µï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å†…ç½‘ç©¿é€ã€‚
>
> å†…ç½‘ç©¿é€å¯ä»¥ä½¿ç”¨natappè½¯ä»¶,å®ƒç»™æˆ‘ä»¬æä¾›ä¸€ä¸ªå¤–ç½‘çš„åŸŸåï¼Œé€šè¿‡æ­¤è½¯ä»¶ï¼ŒæŠŠæˆ‘ä»¬å†…ç½‘webæœåŠ¡å™¨çš„**IP**å’Œ**ç«¯å£**ï¼Œæ˜ å°„åˆ°natappçš„å¤–ç½‘æœåŠ¡å™¨ä¸Šé¢ï¼Œè¿™æ ·å…¬ä¼—å·æœåŠ¡å™¨è®¿é—®åˆ°natappçš„æœåŠ¡å™¨ï¼Œç„¶ånatappæœåŠ¡å™¨åœ¨é€šè¿‡natappè½¯ä»¶åœ¨æŠŠè¯·æ±‚è½¬å‘åˆ°å†…ç½‘ä¸­ï¼Œä»è€Œå°±å®ç°äº†å†…ç½‘çš„ç©¿é€ã€‚

### config.ini

```json
#å°†æœ¬æ–‡ä»¶æ”¾ç½®äºnatappåŒçº§ç›®å½• ç¨‹åºå°†è¯»å– [default] æ®µ
#åœ¨å‘½ä»¤è¡Œå‚æ•°æ¨¡å¼å¦‚ natapp -authtoken=xxx ç­‰ç›¸åŒå‚æ•°å°†ä¼šè¦†ç›–æ‰æ­¤é…ç½®
#å‘½ä»¤è¡Œå‚æ•° -config= å¯ä»¥æŒ‡å®šä»»æ„config.iniæ–‡ä»¶
[default]
authtoken=dd8060448287625b      #å¯¹åº”ä¸€æ¡éš§é“çš„authtoken
clienttoken=                    #å¯¹åº”å®¢æˆ·ç«¯çš„clienttoken,å°†ä¼šå¿½ç•¥authtoken,è‹¥æ— è¯·ç•™ç©º,
log=none                        #log æ—¥å¿—æ–‡ä»¶,å¯æŒ‡å®šæœ¬åœ°æ–‡ä»¶, none=ä¸åšè®°å½•,stdout=ç›´æ¥å±å¹•è¾“å‡º ,é»˜è®¤ä¸ºnone
loglevel=ERROR                  #æ—¥å¿—ç­‰çº§ DEBUG, INFO, WARNING, ERROR é»˜è®¤ä¸º DEBUG
http_proxy=                     #ä»£ç†è®¾ç½® å¦‚ http://10.123.10.10:3128 éä»£ç†ä¸Šç½‘ç”¨æˆ·è¯·åŠ¡å¿…ç•™ç©º
```

### æ³¨æ„äº‹é¡¹

- å…è´¹ç‰ˆæœ¬ä¸è¦å…³é—­cmdçª—å£æˆ–è€…ç»“æŸç¨‹åºçš„è¿è¡Œï¼Œè¿™æ ·ä¼šå¯¼è‡´å¤–ç½‘åŸŸåå˜åŒ–

- æœ¬æœºWEBæœåŠ¡å™¨å¯¹åº”ç«¯å£å·å’ŒnatappæŒ‡å®šçš„ç«¯å£å·å¿…é¡»ä¸€è‡´

- natappé¢æ¿è§£æ

  <img src="https://cdn.jsdelivr.net/gh/ilmangoi/imgRepo@main/img/456465461.png" alt="456465461" style="zoom:50%;" />

## å¼€å‘æ¨¡å¼

### å…¬ä¼—å·æ¥å…¥

> å¼€å‘å­¦ä¹ é˜¶æ®µï¼Œä½¿ç”¨æµ‹è¯•å¹³å°æ¥è¿›è¡Œï¼š
>
> https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login
>
> æ¥å…¥æµç¨‹æ–‡æ¡£ï¼š
>
> https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421135319

**æ¥å…¥è¿‡ç¨‹ï¼š**

<img src="https://cdn.jsdelivr.net/gh/ilmangoi/imgRepo@main/img/%E9%AD%82%E7%89%B5%E6%A2%A6%E8%90%A6%E5%A1%94%E9%A1%B6%E5%A1%94%E9%A1%B6.png" alt="é­‚ç‰µæ¢¦è¦å¡”é¡¶å¡”é¡¶" style="zoom: 67%;" />

- åœ¨æµ‹è¯•å¹³å°ä¸­å¡«å†™çœŸå®å¯è¿æ¥çš„å¤–ç½‘åœ°å€å’Œtokenå€¼ï¼Œè¿™é‡Œçš„tokenè¡¨ç¤ºçº¦å®šå¥½çš„å¯¹ç§°åŠ å¯†å¯†é’¥

<img src="https://cdn.jsdelivr.net/gh/ilmangoi/imgRepo@main/img/fjdklasfj;alsd.png" alt="fjdklasfj;alsd" style="zoom:67%;" />

- æŒ‰ç…§å®˜æ–¹æ¥å…¥æ–‡æ¡£ä¸­çš„åŠ å¯†å’ŒéªŒè¯æ–¹æ¡ˆè¿›è¡ŒåŠ å¯†å’ŒéªŒè¯

> å¼€å‘è€…é€šè¿‡æ£€éªŒ signature å¯¹è¯·æ±‚è¿›è¡Œæ ¡éªŒï¼ˆä¸‹é¢æœ‰æ ¡éªŒæ–¹å¼ï¼‰ã€‚è‹¥ç¡®è®¤æ­¤æ¬¡ GET è¯·æ±‚æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨ï¼Œè¯·åŸæ ·è¿”å› echostr å‚æ•°å†…å®¹ï¼Œåˆ™æ¥å…¥ç”Ÿæ•ˆï¼Œæˆä¸ºå¼€å‘è€…æˆåŠŸï¼Œå¦åˆ™æ¥å…¥å¤±è´¥ã€‚åŠ å¯†/æ ¡éªŒæµç¨‹å¦‚ä¸‹ï¼š
>
> - å°†tokenã€timestampã€nonceä¸‰ä¸ªå‚æ•°è¿›è¡Œå­—å…¸åºæ’åº
>
> - å°†ä¸‰ä¸ªå‚æ•°å­—ç¬¦ä¸²æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œsha1åŠ å¯† 
>
> - å¼€å‘è€…è·å¾—åŠ å¯†åçš„å­—ç¬¦ä¸²å¯ä¸ signature å¯¹æ¯”ï¼Œå› ä¸ºæ ‡è¯†è¯¥è¯·æ±‚æ¥æºäºå¾®ä¿¡ï¼Œå¦‚æœåŠ å¯†ç»“æœä¸è¯¥æ ‡è¯†ä¸ç¬¦ï¼Œåˆ™è¯æ˜æ­¤æ¬¡è¯·æ±‚å¯èƒ½ä¸æ˜¯å¾®ä¿¡å…¬ä¼—å·æœåŠ¡å™¨å‘æ¥çš„(åº”ä¸äºˆç†ä¼š)ã€‚

```js
// æ³¨æ„ï¼šå…¬ä¼—å¹³å°ä¸­çš„éªŒè¯urlä¸ºï¼šhttp://xteert.natappfree.cc/weChat
// å› ä¸ºè¿™é‡Œçš„è·¯ç”±ä¸ºï¼š/weChat
const sha1 = require('sha1')
app.get('/wechat', (req, res) => {
  let { signature, timestamp, nonce, echostr } = req.query
  let arr = [token, timestamp, nonce].sort()
  let cryptStr = sha1(arr.join(''))
  if (signature === cryptStr) {
    res.send(echostr)
  } else {
    res.send('')
  }
})
```

- é…ç½®å¥½æ¥å…¥éªŒè¯å°±å¯ä»¥åœ¨å…¬ä¼—å¹³å°ä¸­ç‚¹å‡»éªŒè¯äº†ï¼Œç„¶åå…¬ä¼—å¹³å°å°±ä¼šå‘é€4ä¸ªå‚æ•°åˆ°æˆ‘ä»¬å¡«å†™çš„å…¬ç½‘æœåŠ¡å™¨ä¸­(é€šè¿‡GETè¯·æ±‚)ï¼Œå¦‚æœèƒ½å¤Ÿé¡ºåˆ©è®¿é—®ï¼Œå¹¶ä¸”æˆ‘ä»¬æ­£ç¡®çš„è¿”å›äº†echostrå­—æ®µï¼Œé‚£ä¹ˆå…¬ä¼—å¹³å°ä¸­å°±ä¼šæç¤ºéªŒè¯æˆåŠŸ

| signature | å¾®ä¿¡åŠ å¯†ç­¾åï¼Œsignatureç»“åˆäº†å¼€å‘è€…å¡«å†™çš„ token å‚æ•°å’Œè¯·æ±‚ä¸­çš„ timestamp å‚æ•°ã€nonceå‚æ•°ã€‚ |
| --------- | ------------------------------------------------------------ |
| timestamp | æ—¶é—´æˆ³                                                       |
| nonce     | éšæœºæ•°                                                       |
| echostr   | éšæœºå­—ç¬¦ä¸²                                                   |

<img src="https://cdn.jsdelivr.net/gh/ilmangoi/imgRepo@main/img/jfdaskljfhiowenmfa.png" alt="jfdaskljfhiowenmfa" style="zoom: 67%;" />

## è¢«åŠ¨å›å¤æ¶ˆæ¯

> å½“æ™®é€šç”¨æˆ·å‘å…¬ä¼—è´¦å·å‘æ¶ˆæ¯æ—¶ï¼Œå¾®ä¿¡æœåŠ¡å™¨å°†POSTæ¶ˆæ¯çš„XMLæ•°æ®åŒ…åˆ°å¼€å‘è€…å¡«å†™çš„URLä¸Šã€‚æ­¤æ—¶æœåŠ¡å™¨å¯ä»¥å¯¹æœ¬æ¬¡æ¥å—åˆ°çš„æ¶ˆæ¯è¿›è¡Œä¸€æ¬¡å“åº”çš„å›å¤ï¼Œç°æ”¯æŒå›å¤ç±»å‹æœ‰ï¼šæ–‡æœ¬ã€å›¾ç‰‡ã€å›¾æ–‡ã€è¯­éŸ³ã€è§†é¢‘ã€éŸ³ä¹ã€‚
>
> ä¸¥æ ¼æ¥è¯´ï¼šå‘é€è¢«åŠ¨å“åº”æ¶ˆæ¯å…¶å®å¹¶ä¸æ˜¯ä¸€ç§æ¥å£ï¼Œè€Œæ˜¯å¯¹å¾®ä¿¡æœåŠ¡å™¨å‘è¿‡æ¥æ¶ˆæ¯çš„ä¸€æ¬¡å›å¤(å“åº”)ã€‚

### å›å¤æ–‡æœ¬æ¶ˆæ¯

- **/router/weChat.js**

```js
const router = require('express').Router()
const wechatController = require('../controller/wechatController')

router.get('/wechat', wechatController.wechat)
router.post('/wechat', wechatController.wechatAction)

module.exports = router
```

- **/controller/wechatController.js**

```js
const xml2js = require('xml2js')
const sendMethod = require('../msgData')
// æ­¤å€¼æ˜¯ä½ å’Œå…¬ä¼—å¹³å°çš„çº¦å®šï¼Œä¸ä¼šé€šè¿‡ç½‘ç»œç›´æ¥ä¼ è¾“,è¿™æ ·ä¹Ÿæ˜¯ä¸ºäº†å®‰å…¨
const token = 'ilmango'

module.exports = {
  // ....
  wechatAction(req, res) {
    let postXmlData = []
    // postä¼ è¿‡æ¥çš„æ•°æ®éƒ½æ˜¯æ•°æ®æµï¼Œä¸èƒ½ç›´æ¥é€šè¿‡req.bodyè·å–
    req.on('data', chunk => postXmlData.push(chunk))
    req.on('end', async () => {
      // å¾—åˆ°å…¬ä¼—å¹³å°postå‘é€è¿‡æ¥çš„æ‰€æœ‰çš„xmlå†…å®¹ string
      let xmlStr = Buffer.concat(postXmlData).toString('utf-8')
      // å°†xmlè½¬æ¢æˆjså¯¹è±¡ä»¥æ–¹ä¾¿æ›´å¥½çš„å»æ“ä½œ
      const xmlParser = new xml2js.Parser()
      // è§£æä¸ºxmlçš„jsonå¯¹è±¡
      let { xml } = await xmlParser.parseStringPromise(xmlStr)
      // å…¬ä¼—å¹³å°çš„idå·
      const toUserName = xml.ToUserName[0]
      // å‘é€ç»™å…¬ä¼—å¹³å°çš„å¾®ä¿¡åœ¨æ­¤å¹³å°çš„å”¯ä¸€idå€¼
      const fromUserName = xml.FromUserName[0]
      // æ¶ˆæ¯ç±»å‹ text image voice video music news
      const msgType = xml.MsgType[0]
      // å‘é€è¿‡æ¥çš„æ¶ˆæ¯å†…å®¹
      const content = xml.Content[0]
      // è¿™é‡Œå¯¹è¿”å›çš„xmlæ•°æ®è¿›è¡Œå°è£…ï¼Œé€šè¿‡msgTypeæ¥åŒºåˆ†è¦è¿”å›ä»€ä¹ˆç»“æ„çš„æ•°æ®
      const sendXml = sendMethod(msgType, fromUserName, toUserName, content)
      // è¢«åŠ¨å“åº”
      res.send(sendXml)
    })
  }
}
```

- **/src/msgData/index.js**

```js
const methods = {
  createTextXml(fromUserName, toUserName, content) {
    // å‘é€çš„æ—¶é—´
    const createTime = Math.floor(Date.now() / 1000);
    // å›å¤ç»™å…¬ä¼—å¹³å°çš„xmlï¼Œè¿™é‡Œfromå’Œtoè§’è‰²è¦äº’æ¢ä¸€ä¸‹
    return `<xml>
      <ToUserName><![CDATA[${fromUserName}]]></ToUserName>
      <FromUserName><![CDATA[${toUserName}]]></FromUserName>
      <CreateTime>${createTime}</CreateTime>
      <MsgType><![CDATA[text]]></MsgType>
      <Content><![CDATA[${content}]]></Content>
    </xml>`;
  },
};

// ç»™å‡ºä¸€ä¸ªç»Ÿä¸€æš´éœ²æ‰€æœ‰æ¶ˆæ¯ç±»å‹çš„æ¥å£
module.exports = function (name, fromUserName, toUserName, content) {
  name = name[0].toLocaleUpperCase() + name.slice(1);
  return methods[`create${name}Xml`](fromUserName, toUserName, content);
};
```

### å›å¤å›¾æ–‡æ¶ˆæ¯

- **/controller/wechatController.js**

```js
const xml2js = require('xml2js')
const sendMethod = require('../msgData')
// æ­¤å€¼æ˜¯ä½ å’Œå…¬ä¼—å¹³å°çš„çº¦å®šï¼Œä¸ä¼šé€šè¿‡ç½‘ç»œç›´æ¥ä¼ è¾“,è¿™æ ·ä¹Ÿæ˜¯ä¸ºäº†å®‰å…¨
const token = 'ilmango'

module.exports = {
  // ....
  wechatAction(req, res) {
    let postXmlData = []
    // postä¼ è¿‡æ¥çš„æ•°æ®éƒ½æ˜¯æ•°æ®æµï¼Œä¸èƒ½ç›´æ¥é€šè¿‡req.bodyè·å–
    req.on('data', chunk => postXmlData.push(chunk))
    req.on('end', async () => {
      // å¾—åˆ°å…¬ä¼—å¹³å°postå‘é€è¿‡æ¥çš„æ‰€æœ‰çš„xmlå†…å®¹ string
      let xmlStr = Buffer.concat(postXmlData).toString('utf-8')
      // å°†xmlè½¬æ¢æˆjså¯¹è±¡ä»¥æ–¹ä¾¿æ›´å¥½çš„å»æ“ä½œ
      const xmlParser = new xml2js.Parser()
      // è§£æä¸ºxmlçš„jsonå¯¹è±¡
      let { xml } = await xmlParser.parseStringPromise(xmlStr)
      // å…¬ä¼—å¹³å°çš„idå·
      const toUserName = xml.ToUserName[0]
      // å‘é€ç»™å…¬ä¼—å¹³å°çš„å¾®ä¿¡åœ¨æ­¤å¹³å°çš„å”¯ä¸€idå€¼
      const fromUserName = xml.FromUserName[0]
      // æ¶ˆæ¯ç±»å‹ text image voice video music news
      let msgType = xml.MsgType[0]
      // å‘é€è¿‡æ¥çš„æ¶ˆæ¯å†…å®¹
      let content = xml.Content ? xml.Content[0] : ''
      // æ ¹æ®ç”¨æˆ·è¾“å…¥çš„æ•°æ®æ¥å†³å®šè¦è¿”å›ä»€ä¹ˆå†…å®¹ï¼Œæ³¨æ„è¿™é‡Œå…ˆåˆ¤æ–­ç”¨æˆ·å‘é€çš„æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œè¿™é‡Œåªæœ‰ç”¨æˆ·å‘é€æ–‡ä»¶æ—¶æ‰ä¼šè¿›è¡Œå“åº”
      if ('text' === msgType) {
        if (content.includes('å¤©æ°”')) { // æ¥æ”¶ç±»å‹ä¸ºtextï¼Œè¿”å›ç±»å‹ä¹Ÿä¸ºtextï¼Œä¸éœ€è¦ä¿®æ”¹
          content = 'æœ‰å¤§é£ï¼Œä¼šå¾ˆå†·ï¼Œå¤šç©¿è¡£æœï¼Œå°‘è¯´è¯ï¼Œå¤šé¢è¯•' // è¦ç»™ç”¨æˆ·è¿”å›çš„å†…å®¹
        }
        if (content === 'å›¾æ–‡') {
          msgType = 'news' // è¦ç»™ç”¨æˆ·è¿”å›çš„æ•°æ®ç±»å‹
          content = { // è¦ç»™ç”¨æˆ·è¿”å›çš„å†…å®¹
            title: 'å…»äº†9ä¸ªæœˆå–äº†4000å—@@',
            description: 'å½“å­©å­åšäº†æ­£ç¡®çš„äº‹æˆ–è€…å–å¾—äº†å¥½çš„æˆç»©æ—¶ï¼Œæ— è®ºæ˜¯å®¶é•¿è¿˜æ˜¯è€å¸ˆï¼Œæ€»ä¼šæƒ³ç€ç»™å­©å­ä¸€äº›å¥–åŠ±ï¼Œä»€ä¹ˆæ ·çš„å¥–åŠ±æ‰æ˜¯æœ€å¥½çš„å‘¢',
            picurl: 'https://p3-sign.toutiaoimg.com/tos-cn-i-tjoges91tu/TKfXAxcC7D0RkG~noop.image?_iz=58558&from=article.pc_detail&x-expires=1666926824&x-signature=JHtSD3qlR1Nj9AVM678%2FCVftEVI%3D',
            url: 'https://www.toutiao.com/article/7156030679283663395/?log_from=861dd6a071e1a_1666322030432'
          }
        }
        const sendXml = sendMethod(msgType, fromUserName, toUserName, content) // æŠŠæ•°æ®åµŒå…¥xmlæ¨¡æ¿
        res.send(sendXml)
      } else { // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„å…³é”®å­—ï¼Œåˆ™è¿”å›ç©º
          res.send('')
      }
    })
  }
}
```

- **/src/msgData/index.js**

```js
const methods = {
  // æ–‡æœ¬æ¶ˆæ¯æ¨¡æ¿
  createTextXml(fromUserName, toUserName, content) {
    const createTime = Math.floor(Date.now() / 1000)
    // å›å¤ç»™å…¬ä¼—å¹³å°çš„xmlï¼Œæ‰€ä»¥ä½ åŸæ¥æ¥å—çš„fromå’Œtoè§’è‰²è¦äº’æ¢ä¸€ä¸‹
    return `<xml>
    <ToUserName><![CDATA[${fromUserName}]]></ToUserName>
    <FromUserName><![CDATA[${toUserName}]]></FromUserName>
    <CreateTime>${createTime}</CreateTime>
    <MsgType><![CDATA[text]]></MsgType>
    <Content><![CDATA[${content}]]></Content>
  </xml>`
  },

  // å›¾æ–‡æ¶ˆæ¯ï¼Œåªèƒ½å‘é€1æ¡
  createNewsXml(fromUserName, toUserName, content) {
    const createTime = Math.floor(Date.now() / 1000)
    return `<xml>
      <ToUserName><![CDATA[${fromUserName}]]></ToUserName>
      <FromUserName><![CDATA[${toUserName}]]></FromUserName>
      <CreateTime>${createTime}</CreateTime>
      <MsgType><![CDATA[news]]></MsgType>
      <ArticleCount>1</ArticleCount>
      <Articles>
        <item>
          <Title><![CDATA[${content.title}]]></Title>
          <Description><![CDATA[${content.description}]]></Description>
          <PicUrl><![CDATA[${content.picurl}]]></PicUrl>
          <Url><![CDATA[${content.url}]]></Url>
        </item>
      </Articles>
    </xml>`
  },
}

module.exports = function (name, fromUserName, toUserName, content) {
  name = name[0].toLocaleUpperCase() + name.slice(1)
  return methods[`create${name}Xml`](fromUserName, toUserName, content)
}
```

## ä¸»åŠ¨å‘é€æ¶ˆæ¯

### è·å–access_token

> - access_tokenæ˜¯å…¬ä¼—å·çš„**å…¨å±€å”¯ä¸€**æ¥å£è°ƒç”¨å‡­æ®ï¼Œå…¬ä¼—å·è°ƒç”¨å„æ¥å£æ—¶éƒ½éœ€ä½¿ç”¨å®ƒã€‚
>
> - access_tokençš„å­˜å‚¨è‡³å°‘è¦ä¿ç•™512ä¸ªå­—ç¬¦ç©ºé—´ã€‚(å¦‚æœä½ è¦å­˜å‚¨åˆ°mysqlä¸­æ³¨æ„è®¾ç½®å­—æ®µé•¿åº¦)
>
> - access_tokençš„æœ‰æ•ˆæœŸç›®å‰ä¸º2ä¸ªå°æ—¶ã€‚
>
> - access_tokençš„æ¯å¤©è¯·æ±‚çš„æ¬¡æ•°ä¸º2000æ¬¡ã€‚(è®¿é—®é‡å¤§çš„è¯éœ€è¦åšç¼“å­˜)
>
> - access_token æ–°è€åˆ‡æ¢çš„ç¼“å†²æ—¶é—´ä¸º5åˆ†é’Ÿå†…ï¼Œä¸¤è€…éƒ½å¯ç”¨ã€‚(å¾®ä¿¡ä¼ å›çš„tokenä¿¡æ¯ä¸­ï¼Œæœ‰ä¸€ä¸ªçš„è¿‡æœŸæ—¶é—´expeirï¼Œå½“è¿™ä¸ªæ—¶é—´æ˜¾ç¤ºè¿‡æœŸåï¼Œåœ¨äº”åˆ†é’Ÿå†…ä»ç„¶æ˜¯å¯ä»¥è®¿é—®çš„ï¼Œå› æ­¤ä¸éœ€è¦æ‹…å¿ƒtokençªç„¶å¤±æ•ˆ)

**æ¥å£è°ƒç”¨è¯·æ±‚è¯´æ˜**

> httpsè¯·æ±‚æ–¹å¼: GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET

**å‚æ•°è¯´æ˜**

| å‚æ•°       | æ˜¯å¦å¿…é¡» | è¯´æ˜                                  |
| :--------- | :------- | :------------------------------------ |
| grant_type | æ˜¯       | è·å–access_tokenå¡«å†™client_credential |
| appid      | æ˜¯       | ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯                    |
| secret     | æ˜¯       | ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯å¯†é’¥ï¼Œå³appsecret   |

**è¿”å›è¯´æ˜**

æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¾®ä¿¡ä¼šè¿”å›ä¸‹è¿° JSON æ•°æ®åŒ…ç»™å…¬ä¼—å·ï¼š

```json
{"access_token":"ACCESS_TOKEN","expires_in":7200}
```

**å‚æ•°è¯´æ˜**

| å‚æ•°         | è¯´æ˜                   |
| :----------- | :--------------------- |
| access_token | è·å–åˆ°çš„å‡­è¯           |
| expires_in   | å‡­è¯æœ‰æ•ˆæ—¶é—´ï¼Œå•ä½ï¼šç§’ |

é”™è¯¯æ—¶å¾®ä¿¡ä¼šè¿”å›é”™è¯¯ç ç­‰ä¿¡æ¯ï¼ŒJSONæ•°æ®åŒ…ç¤ºä¾‹å¦‚ä¸‹ï¼ˆè¯¥ç¤ºä¾‹ä¸º AppID æ— æ•ˆé”™è¯¯ï¼‰:

```json
{"errcode":40013,"errmsg":"invalid appid"}
```

**è·å–access_tokenç¤ºä¾‹ï¼š**

- **/utils/tools.js**

```js
const fs = require('fs')
const path = require('path')
const axios = require('axios')

// æµ‹è¯•å·ä¿¡æ¯ï¼Œç”¨äºè¯·æ±‚å¾®ä¿¡å…¬ä¼—å¹³å°çš„å‡­æ®
const appid = 'wxae077dbd6d0b42b8'
const secret = '12692272e71906eacbdde9e3023e3062'

const getAccessToken = async () => {
  // access_tokenç¼“ä»¶æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®ï¼Œè¿™é‡Œåœ¨æ–‡ä»¶åä¸­åŠ å…¥äº†appidï¼Œè¿™æ˜¯ç”±äºè¯¥æœåŠ¡å™¨å¯ä»¥ä¼šè¢«å¤šä¸ªå…¬ä¼—å·æ¥å…¥ï¼Œå› æ­¤å¯ä»¥ä¼šä¿å­˜å¤šä¸ªtokenï¼Œä¸ºäº†é˜²æ­¢æ··ä¹±ï¼Œåˆ™ä½¿ç”¨ä½œä¸ºå…¬ä¼—å·æ ‡è¯†çš„appidä½œä¸ºæ–‡ä»¶å
  let tokenCacheFilePath = path.resolve(`./cache/${appid}_token.db`)
  // tokenè¿‡æœŸæ—¶é—´ä¸ºä¸¤å°æ—¶ï¼Œè¿™é‡Œè®©ä»–æ¯ä¸€å°æ—¶é‡å¤è¯·æ±‚ä¸€æ¬¡
  let expire = 3600000
  // ä¿å­˜è¯·æ±‚åˆ°çš„token
  let accessToken = ''
  // åˆ¤æ–­å½“å‰æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™åˆ¤æ–­å½“å‰æ–‡ä»¶æœ€åçš„ä¿®æ”¹æ—¶é—´+è¿‡æœŸæ—¶é—´å€¼ï¼Œæ˜¯å¦å¤§äºå½“å‰æ—¶é—´ï¼Œå¦‚æœå¤§äºï¼Œåˆ™è¡¨æ²¡æœ‰è¿‡æœŸï¼Œå¦‚æœå°äºåˆ™è¿‡æœŸï¼Œå°±éœ€è¦é‡æ–°æ¥è·å–
  if (fs.existsSync(tokenCacheFilePath)) {
    let stat = fs.statSync(tokenCacheFilePath)
    let expireTime = stat.mtime.getTime() + expire
    let currentTime = Date.now()
    if (currentTime < expireTime) {
      let accessToken = fs.readFileSync(tokenCacheFilePath, 'utf-8')
      return accessToken
    }
  }
  // æ–‡ä»¶ä¸å­˜åœ¨æˆ–è¿‡æœŸ
  let url = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appid}&secret=${secret}`
  // å‘èµ·getè¯·æ±‚
  let ret = await axios.get(url)
  // ä¿å­˜è¯·æ±‚åˆ°çš„token
  accessToken = ret.data.access_token
  // å†™å…¥åˆ°ç¼“å­˜ä¸­
  fs.writeFileSync(tokenCacheFilePath, accessToken)
  // è¿”å›token
  return accessToken
}

module.exports = {
  getAccessToken
}
```

### ä¸Šä¼ ç´ æ

> å…¬ä¼—å·ç»å¸¸æœ‰éœ€è¦ç”¨åˆ°ä¸€äº›ä¸´æ—¶æ€§çš„å¤šåª’ä½“ç´ æçš„åœºæ™¯ï¼Œä¾‹å¦‚åœ¨ä½¿ç”¨æ¥å£ç‰¹åˆ«æ˜¯å‘é€æ¶ˆæ¯æ—¶ï¼Œå¯¹å¤šåª’ä½“æ–‡ä»¶ã€å¤šåª’ä½“æ¶ˆæ¯çš„è·å–å’Œè°ƒç”¨ç­‰æ“ä½œï¼Œæ˜¯é€šè¿‡media_idæ¥è¿›è¡Œçš„ã€‚å…¬å¹³å¹³å°æä¾›äº†ä¸¤ç§ç´ ææ¨¡å¼ï¼Œä¸€æ˜¯ä¸´æ—¶ç´ æï¼ŒäºŒæ˜¯æ°¸ä¹…ç´ æï¼Œåˆ†åˆ«ä½¿ç”¨ä¸åŒçš„æ¥å£ã€‚ä»–ä»¬çš„åŒºåˆ«å°±æ˜¯ä¸´æ—¶ç´ æä¿å­˜ä¸‰å¤©åä¼šè‡ªåŠ¨è¢«åˆ é™¤ï¼Œè€Œæ°¸ä¹…ç´ æä¸ä¼šè¢«åˆ é™¤ï¼Œä½†æ˜¯æœ‰ä¸Šé™ã€‚

**å®‰è£…ä¾èµ–ï¼š**

> npm install form-data concat-stream --save

ç”±äºnodeä¸­ä¸æ”¯æŒform-dataï¼Œå› æ­¤è¿™é‡Œéœ€è¦å®‰è£…ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚form-dataåˆ›å»ºå‡ºæ¥çš„formDataå¯¹è±¡æ”¯æŒç®¡é“pipeï¼Œå› æ­¤å®ƒå¯ä»¥å’Œconcaté…åˆçš„å¾ˆå¥½ã€‚

concat-streamç”¨äºè¿æ¥å¤šä¸ªæ•°æ®æµï¼Œæµå‘å‡ºè®¸å¤šç¼“å†²åŒºã€‚å¦‚æœæ‚¨æƒ³æ”¶é›†æ‰€æœ‰çš„ç¼“å†²åŒºï¼Œå¹¶ä¸”å½“æµç»“æŸæ—¶å°†æ‰€æœ‰çš„ç¼“å†²åŒºè¿æ¥åœ¨ä¸€èµ·å¹¶æ¥æ”¶ä¸€ä¸ªå•ç‹¬çš„ç¼“å†²åŒºï¼Œé‚£å°±å¯ä»¥ä½¿ç”¨concat-streamã€‚readStreamä¸€èˆ¬æ˜¯æ¥å…¥writeStreamä¸­ï¼Œä»¥ç›´æ¥è¾“å‡ºæ–‡ä»¶ï¼Œå¦‚æœåªæ˜¯æƒ³æŠŠè¯»å†™æµçš„ç¼“å­˜ç‰‡æ–­è¿æ¥èµ·æ¥ï¼Œè€Œä¸æ˜¯è¾“å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œå°±å¯ä»¥ç›´æ¥æŠŠreadStreamè¿æ¥åˆ°concatStreamä¸­ï¼ŒconcatStramæ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°çš„å‚æ•°å°±æ˜¯è¿æ¥å®Œæˆçš„ç¼“å†²åŒºã€‚

```js
var fs = require('fs')
var concat = require('concat-stream')
 
var readStream = fs.createReadStream('cat.png')
var concatStream = concat(gotPicture)
 
readStream.on('error', handleError)
readStream.pipe({ encoding: 'buffer' }, concatStream)
 
function gotPicture(imageBuffer) {
  // imageBuffer is all of `cat.png` as a node.js Buffer
}
 
function handleError(err) {
  // handle your error appropriately here, e.g.:
  console.error(err) // print the error to STDERR
  process.exit(1) // exit program with non-zero exit code
}
```

- **/router/weChat.jsï¼ˆç¼–å†™ä¸Šä¼ ä¸´æ—¶ç´ æçš„æ¥å£ï¼‰**

> å¦‚æœæœ‰æ•°æ®åº“ï¼Œå¯ä»¥æŠŠä¸Šä¼ æˆåŠŸçš„media_idæ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­,è¿™æ ·åœ¨éœ€è¦media_idæ—¶,å°±å¯ä»¥è¯»å–æ•°æ®è¡¨ä¸­çš„æ•°æ®æ¥ç”¨ï¼Œæ•°æ®åº“å­—æ®µå¦‚ä¸‹ï¼š
>
> | å”¯ä¸€æ ‡è¯† | åª’ä½“id(æ ‡è¯†åª’ä½“æ•°æ®) | åª’ä½“æ•°æ®ç±»å‹ | æ˜¯å¦ä¸ºæ°¸ä¹…å­˜å‚¨ | æœ¬åœ°æœåŠ¡å™¨ä¸­çš„çœŸå®åª’ä½“æ•°æ®åœ°å€ | åª’ä½“æ–‡ä»¶ä¸Šä¼ æ—¶é—´æˆ³ |
> | -------- | -------------------- | ------------ | -------------- | ------------------------------ | ------------------ |
> | id       | media_id             | type         | isforver       | filepath                       | ctime              |
>
> å¯ä»¥é€šè¿‡isforeveræ¥åˆ¤æ–­è¯¥åª’ä½“èµ„æºåœ¨å…¬ä¼—å¹³å°ä¸­æ˜¯å¦æ˜¯æ°¸ä¹…å­˜å‚¨çš„ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥æ ¹æ®åˆ›å»ºæ—¶é—´åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ¥åˆ¤æ–­èµ„æºæ˜¯å¦å¤±æ•ˆï¼Œå¦‚æœå¤±æ•ˆåˆ™å¯ä»¥é‡æ–°ä¸Šä¼ ï¼Œç„¶åç”¨æ–°çš„media_idæ¥æ›¿æ¢æ—§çš„media_idï¼Œä¹Ÿå¯ä»¥ç›´æ¥åˆ é™¤æ‰è¯¥èµ„æºï¼Œé€šè¿‡realpathæ¥åˆ é™¤æ‰æœ¬åœ°å­˜å‚¨çš„åª’ä½“èµ„æºã€‚

```js
const router = require('express').Router()
const { getAccessToken } = require('../utils/tools')

// ç´ æä¸Šä¼ åŠŸèƒ½æ‰€ç”¨åˆ°çš„ç±»åº“
const FormData = require('form-data')
const concat = require('concat-stream')
const axios = require('axios')
const fs = require('fs')
const path = require('path')

// ... ...

// å®šä¹‰ä¸€ä¸ªå¯ä»¥ä¸Šä¼ æœåŠ¡å™¨ä¸Šé¢çš„èµ„æºåˆ°å…¬ä¼—å¹³å°ä¸Šï¼Œå¹¶ä¸”è¦æ±‚å®ƒè¿”å›media_id
router.get('/material', async (req, res) => {
  let type = req.query.type || 'image'
  let accessToken = await getAccessToken()
  // ä¸Šä¼ åˆ°å…¬ä¼—å¹³å°ä¸­çš„postè¯·æ±‚åœ°å€
  let url = `https://api.weixin.qq.com/cgi-bin/media/upload?access_token=${accessToken}&type=${type}`
  // ä½¿ç”¨postæäº¤ä¸€ä¸ªè¡¨å•çš„å½¢å¼æ¥æäº¤å›¾ç‰‡(å¹³å°è¦æ±‚),åœ¨nodeç¯å¢ƒä¸­éœ€è¦ä¸‹è½½form-dataåŒ…ï¼Œå¦‚æœæ˜¯åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œåˆ™æ˜¯ç›´æ¥å†…ç½®çš„
  let formData = new FormData()
  // å…ˆé€šè¿‡å‰ç«¯æŠŠå›¾ç‰‡ä¸Šä¼ è¯¥å›¾ç‰‡åˆ°è¯¥æœåŠ¡å™¨ä¸­çš„æŒ‡å®šåœ°å€ï¼Œç„¶åå†æŠŠè¯¥å›¾ç‰‡æ‘„åƒå¤´åˆ°å…¬ä¼—å¹³å°ï¼Œè·å–media_id
  formData.append('media', fs.createReadStream(path.resolve('./uploads/face.jpg')))
  formData.pipe(
    concat({ encoding: 'buffer' }, async data => {
      // dataå°±æ˜¯è¿æ¥å®Œæˆçš„bufferæ ¼å¼çš„è¡¨å•æ•°æ®ï¼Œå¯ä»¥ç›´æ¥å°†å®ƒä½œä¸ºè¯·æ±‚ä½“ï¼ŒæŠŠå›¾ç‰‡ä¸Šä¼ åˆ°å…¬ä¼—å¹³å°
      let result = await axios.post(url, data, {
        headers: {
          'content-type': 'multipart/form-data'
        }
      })
      // è¿”å›media_id
      res.send(result.data)
    })
  )
})

module.exports = router
```

### å›å¤å›¾ç‰‡ã€è§†é¢‘æ¶ˆæ¯

- **/controller/wechatController.js**

```js
const xml2js = require('xml2js')
const sendMethod = require('../msgData')
// æ­¤å€¼æ˜¯ä½ å’Œå…¬ä¼—å¹³å°çš„çº¦å®šï¼Œä¸ä¼šé€šè¿‡ç½‘ç»œç›´æ¥ä¼ è¾“,è¿™æ ·ä¹Ÿæ˜¯ä¸ºäº†å®‰å…¨
const token = 'ilmango'

module.exports = {
  // ....
  wechatAction(req, res) {
    let postXmlData = []
    // postä¼ è¿‡æ¥çš„æ•°æ®éƒ½æ˜¯æ•°æ®æµï¼Œä¸èƒ½ç›´æ¥é€šè¿‡req.bodyè·å–
    req.on('data', chunk => postXmlData.push(chunk))
    req.on('end', async () => {
      // å¾—åˆ°å…¬ä¼—å¹³å°postå‘é€è¿‡æ¥çš„æ‰€æœ‰çš„xmlå†…å®¹ string
      let xmlStr = Buffer.concat(postXmlData).toString('utf-8')
      // å°†xmlè½¬æ¢æˆjså¯¹è±¡ä»¥æ–¹ä¾¿æ›´å¥½çš„å»æ“ä½œ
      const xmlParser = new xml2js.Parser()
      // è§£æä¸ºxmlçš„jsonå¯¹è±¡
      let { xml } = await xmlParser.parseStringPromise(xmlStr)
      // å…¬ä¼—å¹³å°çš„idå·
      const toUserName = xml.ToUserName[0]
      // å‘é€ç»™å…¬ä¼—å¹³å°çš„å¾®ä¿¡åœ¨æ­¤å¹³å°çš„å”¯ä¸€idå€¼
      const fromUserName = xml.FromUserName[0]
      // æ¶ˆæ¯ç±»å‹ text image voice video music news
      let msgType = xml.MsgType[0]
      // å‘é€è¿‡æ¥çš„æ¶ˆæ¯å†…å®¹
      let content = xml.Content ? xml.Content[0] : ''
      // æ ¹æ®ç”¨æˆ·è¾“å…¥çš„æ•°æ®æ¥å†³å®šè¦è¿”å›ä»€ä¹ˆå†…å®¹ï¼Œæ³¨æ„è¿™é‡Œå…ˆåˆ¤æ–­ç”¨æˆ·å‘é€çš„æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œè¿™é‡Œåªæœ‰ç”¨æˆ·å‘é€æ–‡ä»¶æ—¶æ‰ä¼šè¿›è¡Œå“åº”
      if ('text' === msgType) {
		// ... ...
        if (content === 'å›¾ç‰‡') {
          msgType = 'image' // è¦ç»™ç”¨æˆ·è¿”å›çš„æ•°æ®ç±»å‹
          // è¦ç»™ç”¨æˆ·è¿”å›çš„å†…å®¹, é€šè¿‡ç´ æç®¡ç†ä¸­çš„æ¥å£ä¸Šä¼ å¤šåª’ä½“æ–‡ä»¶ï¼Œå¾—åˆ°çš„idã€‚
          content = 'gDE3n-X71Pi1i7aNzNcsO4ZgWFFb9FKINZII0XIov3g_m8XQxZNX0dBdpMSu6XSO'
        }
        if (content === 'è§†é¢‘') {
          msgType = 'video' // è¦ç»™ç”¨æˆ·è¿”å›çš„æ•°æ®ç±»å‹
          content = { // è¦ç»™ç”¨æˆ·è¿”å›çš„å†…å®¹
            mediaId: 'gDE3n-X71Pi1i7aNzNcsO85GYQ_1RyYL9OzroAzqEl6b1mHeSpdFQzCYz8265GJz',
            title: 'ä½ å¥½è§†é¢‘',
            description: 'è¿™å°±æ˜¯ä¸€ä¸ªè§†é¢‘'
          }
        }
        const sendXml = sendMethod(msgType, fromUserName, toUserName, content) // æŠŠæ•°æ®åµŒå…¥xmlæ¨¡æ¿
        res.send(sendXml)
      } else { // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„å…³é”®å­—ï¼Œåˆ™è¿”å›ç©º
          res.send('')
      }
    })
  }
}
```

- **/src/msgData/index.js**

```js
const methods = {
  // ... ...
  // å›¾ç‰‡æ¶ˆæ¯æ¨¡æ¿
  createImageXml(fromUserName, toUserName, mediaId) {
    const createTime = Math.floor(Date.now() / 1000)
    return `<xml>
      <ToUserName><![CDATA[${fromUserName}]]></ToUserName>
      <FromUserName><![CDATA[${toUserName}]]></FromUserName>
      <CreateTime>${createTime}</CreateTime>
      <MsgType><![CDATA[image]]></MsgType>
      <Image>
        <MediaId><![CDATA[${mediaId}]]></MediaId>
      </Image>
    </xml>
    `
  },
  // è§†é¢‘æ¶ˆæ¯æ¨¡æ¿
  createVideoXml(fromUserName, toUserName, content) {
    const createTime = Math.floor(Date.now() / 1000)
    return `<xml>
      <ToUserName><![CDATA[${fromUserName}]]></ToUserName>
      <FromUserName><![CDATA[${toUserName}]]></FromUserName>
      <CreateTime>${createTime}</CreateTime>
      <MsgType><![CDATA[video]]></MsgType>
      <Video>
      <MediaId><![CDATA[${content.mediaId}]]></MediaId>
      <Title><![CDATA[${content.title}]]></Title>
      <Description><![CDATA[${content.description}]]></Description>
    </Video>
    </xml>
    `
  }
}

module.exports = function (name, fromUserName, toUserName, content) {
  name = name[0].toLocaleUpperCase() + name.slice(1)
  return methods[`create${name}Xml`](fromUserName, toUserName, content)
}
```

### ç¾¤å‘æ¶ˆæ¯

> è®¢é˜…å·æ¯å¤©å¯ä»¥ç¾¤å‘ä¸€æ¡æ¶ˆæ¯ï¼Œè€ŒæœåŠ¡å·æ¯ä¸ªæœˆå¯ä»¥ç¾¤å‘å››æ¡æ¶ˆæ¯ï¼Œç¾¤å‘æ¶ˆæ¯ä¸­çš„å›¾æ–‡æ¶ˆæ¯æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªå›¾æ–‡æ¶ˆæ¯åªèƒ½æ”¯æŒ1åˆ°8æ¡å›¾æ–‡
>
> ç¾¤å‘å›¾æ–‡æ¶ˆæ¯éœ€è¦å…ˆä¸Šä¼ ç´ æï¼Œç„¶åæ‰èƒ½å¾—åˆ°media_idã€‚å¾—åˆ°media_idåæ‰èƒ½ç¾¤å‘æ¶ˆæ¯ï¼Œå¹¶ä¸”ç¾¤å‘åçš„æ¶ˆæ¯ä¸ä¼šé©¬ä¸Šæ¨é€ç»™çš„å…³æ³¨çš„ç²‰ä¸ï¼Œå®ƒä¼šæœ‰ä¸€æ®µæ—¶é—´çš„å»¶æ—¶ï¼Œå¦‚æœæƒ³è¦ç«‹å³æŸ¥çœ‹æ¨é€çš„ç¾¤å‘æ¶ˆæ¯ï¼Œå¯ä»¥å–æ¶ˆå…³æ³¨å†é‡æ–°å…³æ³¨ã€‚

```js
const router = require('express').Router()
const { getAccessToken } = require('../utils/tools')

// ä¸Šä¼ è¦ç¾¤å‘çš„å›¾æ–‡æ¶ˆæ¯åˆ—è¡¨ï¼Œè·å–media_id
router.get('/upmpnews', async (req, res) => {
  let accessToken = await getAccessToken()
  var url = `https://api.weixin.qq.com/cgi-bin/media/uploadnews?access_token=${accessToken}`
  let postData = {
    articles: [
      {
        // ç¼©ç•¥å›¾id, åˆ—è¡¨çš„ç¬¬ä¸€æ¡å›¾æ–‡æ¶ˆæ¯çš„ç¼©ç•¥å›¾ä¼šæ˜¾ç¤ºä¸ºå¤§å›¾(å°é¢)
        thumb_media_id: 'gDE3n-X71Pi1i7aNzNcsOzhvkHUzMGF50AUSYNClN0ltOM8Ta7Qisw79HypqAlUh',
        author: 'å¼ ä¸‰', // ä½œè€…
        title: 'æ¹–åŒ—è¥„é˜³æ•™è‚²ç³»ç»Ÿå®æ–½â€œå››å¤§å·¥ç¨‹â€æ‰“é€ æ¸…å»‰å­¦æ ¡', // æ ‡é¢˜
        content_source_url: 'www.qq.com', // é˜…è¯»åŸæ–‡é“¾æ¥åˆ°çš„åœ°å€
        content: '... ...', // æ­£æ–‡å†…å®¹
        digest: 'digest', // æ‘˜è¦
        show_cover_pic: 1, // æ˜¯å¦æ˜¾ç¤ºå°é¢
        need_open_comment: 1, // æ˜¯å¦æ‰“å¼€è¯„è®º
        only_fans_can_comment: 1 // æ˜¯å¦ä»…ä¸ºç²‰ä¸æ‰å¯ä»¥è¯„è®º
      },
      {
        // é™¤ç¬¬ä¸€æ¡æ¶ˆæ¯å¤–ä¼šæ˜¾ç¤ºä¸ºå›¾æ ‡
        thumb_media_id: 'gDE3n-X71Pi1i7aNzNcsOzhvkHUzMGF50AUSYNClN0ltOM8Ta7Qisw79HypqAlUh',
        author: 'æå››',
        title: 'åƒé”‹å­¦å‘˜ï¼šå¤§å››ä»”é—¯ITï¼Œåˆšæ¯•ä¸šæ‹¿ä¸‹13k',
        content_source_url: 'www.qq.com',
        content: '... ...',
        digest: 'digest',
        show_cover_pic: 0,
        need_open_comment: 1,
        only_fans_can_comment: 1
      }ï¼Œ
      // ... ...
    ]
  }
  let ret = await axios.post(url, postData)
  res.send(ret.data)
})

// é€šè¿‡è·å–åˆ°çš„media_idç¾¤å‘æ¶ˆæ¯
router.get('/mpnews', async (req, res) => {
  let accessToken = await getAccessToken()
  let url = `https://api.weixin.qq.com/cgi-bin/message/mass/sendall?access_token=${accessToken}`
  let postData = {
    filter: {
      is_to_all: true
    },
    mpnews: {
      media_id: '28Ne3ao4EAC-9IV1e6dFGw0PrPKZbLbrEg6MO3MzyG8jtzmfkB4GjxSvuTymKalp'
    },
    msgtype: 'mpnews',
    send_ignore_reprint: 0
  }
  let ret = await axios.post(url, postData)
  res.send(ret.data)
})

module.exports = router
```

## è‡ªå®šä¹‰èœå•

> å¾®ä¿¡å…¬ä¼—å·é»˜è®¤æ²¡æœ‰å¼€é€šåº•éƒ¨èœå•åŠŸèƒ½ï¼Œéœ€è¦ä½¿ç”¨è€…è‡ªè¡Œæ¥åˆ›å»ºå¼€é€šã€‚
>
> **æ³¨æ„ç‚¹ï¼š**
>
> - è‡ªå®šä¹‰èœå•æœ€å¤šåŒ…æ‹¬3ä¸ªä¸€çº§èœå•ï¼Œæ¯ä¸ªä¸€çº§èœå•æœ€å¤šåŒ…å«5ä¸ªäºŒçº§èœå•ã€‚
>
> - ä¸€çº§èœå•æœ€å¤š4ä¸ªæ±‰å­—ï¼ŒäºŒçº§èœå•æœ€å¤š8ä¸ªæ±‰å­—ï¼Œå¤šå‡ºæ¥çš„éƒ¨åˆ†å°†ä¼šä»¥â€œ...â€ä»£æ›¿ã€‚
>
> - åˆ›å»ºè‡ªå®šä¹‰èœå•åï¼Œèœå•çš„åˆ·æ–°ç­–ç•¥æ˜¯ï¼Œåœ¨ç”¨æˆ·è¿›å…¥å…¬ä¼—å·ä¼šè¯é¡µæˆ–å…¬ä¼—å·profileé¡µæ—¶ï¼Œå¦‚æœå‘ç°ä¸Šä¸€æ¬¡æ‹‰å–èœå•çš„è¯·æ±‚åœ¨5åˆ†é’Ÿä»¥å‰ï¼Œå°±ä¼šæ‹‰å–ä¸€ä¸‹èœå•ï¼Œå¦‚æœèœå•æœ‰æ›´æ–°ï¼Œå°±ä¼šåˆ·æ–°å®¢æˆ·ç«¯çš„èœå•ã€‚æµ‹è¯•æ—¶å¯ä»¥å°è¯•å–æ¶ˆå…³æ³¨å…¬ä¼—è´¦å·åå†æ¬¡å…³æ³¨ï¼Œåˆ™å¯ä»¥çœ‹åˆ°åˆ›å»ºåçš„æ•ˆæœã€‚
>
> - æœ€å¸¸ç”¨çš„è‡ªå®šä¹‰ç±»å‹æŒ‰é’®ä¸ºï¼š
>   - view å®ƒç›¸å½“äºhtmlä¸­çš„aæ ‡ç­¾çš„ä½œç”¨  
>   - click è§¦å‘äº‹ä»¶ï¼Œè§¦å‘åä¼šè¯·æ±‚æˆ‘ä»¬æœåŠ¡å™¨ä¸­çš„/weChatçš„postæ¥å£ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œåˆ¤æ–­æ¶ˆæ¯ç±»å‹ï¼Œå¦‚æœæ˜¯äº‹ä»¶å°±è¦åˆ¤æ–­å®ƒæ˜¯ä»€ä¹ˆäº‹ä»¶(å¦‚æœæˆ‘ä»¬æŠŠæŒ‰é’®è®¾ä¸ºclickï¼Œåˆ™éœ€è¦é¢å¤–ä¼ å…¥ä¸€ä¸ªkeyså±æ€§ï¼Œå®ƒå°±è¡¨ç¤ºäº‹ä»¶æ ‡è¯†)ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„å¤„ç†
>   - miniprogram ç‚¹å‡»miniprogramç±»å‹çš„æŒ‰é’®å¯ä»¥è·³è½¬åˆ°å°ç¨‹åºä¸­

### åˆ›å»ºèœå•ï¼š

```js
const router = require('express').Router()
const { getAccessToken } = require('../utils/tools')

router.get('/createMenu', async (req, res) => {
  let accessToken = await getAccessToken()
  let url = `https://api.weixin.qq.com/cgi-bin/menu/create?access_token=${accessToken}`
  let postData = {
    button: [
      {
        name: 'å­¦ä¹ èµ„æº',
        sub_button: [
          {
            type: 'view',
            name: 'Bç«™ç›´è¾¾',
            url: 'http://www.soso.com/'
          },
          {
            type: 'view',
            name: 'ç›´æ’­é¢„çº¦',
            url: 'https://m.baidu.com/'
          }
        ]
      },
      {
        type: 'click',
        name: 'è§†é¢‘æ•™ç¨‹',
        key: 'click001'
      },
      {
        name: 'ç ¸è›‹èµ¢å¥–',
        sub_button: [
          {
            type: 'view',
            name: 'æŠ½å¥–å…¥å£',
            url: 'http://www.soso.com/'
          },
          {
            type: 'click',
            name: 'å’¨è¯¢å°åƒ',
            key: 'click002'
          }
        ]
      }
    ]
  }
  let ret = await axios.post(url, postData)
  res.send(ret.data)
})

module.exports = router
```

### åˆ é™¤èœå•

```js
const router = require('express').Router()
const { getAccessToken } = require('../utils/tools')

router.get('/delMenu', async (req, res) => {
  let accessToken = await getAccessToken()
  let url = `https://api.weixin.qq.com/cgi-bin/menu/delete?access_token=${accessToken}`
  let ret = await axios.get(url)
  res.send(ret.data)
})

module.exports = router
```

## äº‹ä»¶(è®¢é˜…äº‹ä»¶å’ŒæŒ‰é’®äº‹ä»¶)

> å½“ç”¨æˆ·è®¢é˜…æœ¬å…¬ä¼—å·æ—¶ï¼Œåº”è¯¥æŠŠç”¨æˆ·æ•°æ®è®°å½•åˆ°æ•°æ®åº“ä¸­ï¼Œæ•°æ®è¡¨è®¾è®¡å¦‚ä¸‹ï¼š
>
> | id       | openid                     | active                         | ctime        | mtime        | leavel1    | leavel2    | leavel3    |
> | -------- | -------------------------- | ------------------------------ | ------------ | ------------ | ---------- | ---------- | ---------- |
> | å”¯ä¸€æ ‡è¯† | ç”¨æˆ·å¯¹åº”è¯¥å…¬ä¼—å¹³å°çš„å”¯ä¸€id | æ˜¯å¦å…³æ³¨ï¼š0ä¸ºæ²¡æœ‰å…³æ³¨ï¼Œ1ä¸ºå…³æ³¨ | åˆæ¬¡å…³æ³¨æ—¶é—´ | å†æ¬¡å…³æ³¨æ—¶é—´ | ä¸€çº§åˆ†é”€å•† | äºŒçº§åˆ†é”€å•† | ä¸‰çº§åˆ†é”€å•† |

- **/utils/db.js**

```js
const mysql = require('mysql')
// è¿æ¥æ•°æ®åº“,ä»¥æ•°æ®åº“è¿æ¥æ± çš„æ–¹æ¡ˆæ¥ï¼Œè¿™æ ·æ•ˆç‡ä¼šæ›´é«˜ä¸€äº›
const db = mysql.createPool({
  connectionLimit: 2, // åˆ›å»ºå¤šå°‘ä¸ªè¿æ¥å¥æŸ„(è¿æ¥æ± ä¸­ä¿æŒè¿æ¥çŠ¶æ€çš„è¿æ¥æ•°)
  database: 'wechat', // æ•°æ®åº“çš„åç§°
  user: 'root', // è¿æ¥æ•°æ®åº“çš„è´¦å·
  password: 'root' // è¿æ¥æ•°æ®åº“çš„å¯†ç 
})

// æŸ¥è¯¢ç¬¬ä¸€æ¡åŒ¹é…çš„è®°å½•
const first = sql => {
  return new Promise((resolve, reject) => {
    db.query(sql, (err, result, fields) => {
      if (err) reject(err)
      else resolve(result[0])
    })
  })
}

// æŸ¥è¯¢æ‰€æœ‰åŒ¹é…çš„è®°å½•
const all = sql => {
  return new Promise((resolve, reject) => {
    db.query(sql, (err, result, fields) => {
      if (err) reject(err)
      else resolve(result)
    })
  })
}

module.exports = {
  first,
  all
}
```

- **/app.js**

> å¼•å…¥**/utils/db.js**è¿æ¥æ•°æ®åº“ï¼Œå¹¶è·å–æŸ¥è¯¢æ–¹æ³•(first, all)ï¼Œä¹‹æ‰€æœ‰è¦åœ¨å…¥å£æ–‡ä»¶ä¸­å¯¼å…¥æ˜¯å› ä¸ºåªéœ€è¦åœ¨å…¥å£æ–‡ä»¶ä¸­å¯¼å…¥ä¸€æ¬¡ï¼Œå°±å¯ä»¥æŠŠå¯¼å…¥çš„æŸ¥è¯¢æ–¹æ³•ä¼ é€’ç»™è·¯ç”±ä¸­

```js
var createError = require("http-errors");
var express = require("express");
var path = require("path");
var cookieParser = require("cookie-parser");
var logger = require("morgan");
const query = require('./utils/db'); // å¯¼å…¥æ•°æ®åº“å­˜æŸ¥è¯¢æ–¹æ³•

var app = express();

// view engine setup
app.set("views", path.join(__dirname, "views"));
app.set("view engine", "ejs");

app.use(logger("dev"));
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(cookieParser());
app.use(express.static(path.join(__dirname, "public")));

// å¼•å…¥è·¯ç”±(æŠŠæ•°æ®åº“æŸ¥è¯¢æ–¹æ³•ä¼ é€’ç»™è·¯ç”±)
app.use(require("./routes")(query));

// catch 404 and forward to error handler
app.use(function (req, res, next) {
  next(createError(404));
});

// error handler
app.use(function (err, req, res, next) {
  // set locals, only providing error in development
  res.locals.message = err.message;
  res.locals.error = req.app.get("env") === "development" ? err : {};

  // render the error page
  res.status(err.status || 500);
  res.render("error");
});

module.exports = app;
```

- **/routes/index.js**

> é€šè¿‡è·¯ç”±å…¥å£æ–‡ä»¶å°†queryç»§ç»­å‘ä¸‹ä¼ é€’

```js
var express = require("express");
var router = express.Router();

const mainRouter = query => {
  /* GET home page. */
  router.get("/", function (req, res, next) {
    res.render("index", { title: "Express" });
  });
  router.use(require('./weChat')(query))
  return router
}

module.exports = mainRouter
```

- **/routes/weChat.js**

> é€šè¿‡åŒ…è£…å‡½æ•°è·å–åˆ°queryï¼Œå¹¶æŠŠfirstä¼ é€’ç»™weChatController

```js
var express = require("express");
var router = express.Router();
var weChatController = require("../controller/weChatController");
var { getAccessToken } = require("../utils/tools");

// ç´ æä¸Šä¼ åŠŸèƒ½æ‰€ç”¨åˆ°çš„ç±»åº“
const FormData = require("form-data");
const concat = require("concat-stream");
const axios = require("axios");
const fs = require("fs");
const path = require("path");

const weChatRouter = ({ first, all }) => {
  router.get("/weChat", weChatController.weChat);
  router.post("/weChat", weChatController.weChatAction(first));
  // ... ...
  return router
};

module.exports = weChatRouter;

```

- **/controller/wechatController.js**

> åœ¨ç”¨æˆ·è®¢é˜…æ—¶ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œåœ¨ç”¨æˆ·å–æ¶ˆè®¢é˜…æ—¶ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¸­çš„activeå­—æ®µä¿®æ”¹ä¸€ä¸‹

```js
//! æ§åˆ¶å™¨ï¼Œè·¯ç”±åŒ¹é…æˆåŠŸåï¼Œç”¨ä»–æ¥å¤„ç†ä¸šåŠ¡é€»è¾‘
const sha1 = require("sha1");
const xml2js = require("xml2js");
const sendMethod = require("../msgData");
const moment = require("moment");
const token = "ilmango";

const controller = {
  // ... ...
  weChatAction(first) {
    return (req, res) => {
      let postXmlData = [];
      // postä¼ è¿‡æ¥çš„æ•°æ®éƒ½æ˜¯æ•°æ®æµï¼Œä¸èƒ½ç›´æ¥é€šè¿‡req.bodyè·å–
      req.on("data", (chunk) => postXmlData.push(chunk));
      req.on("end", async () => {
        // å¾—åˆ°å…¬ä¼—å¹³å°postå‘é€è¿‡æ¥çš„æ‰€æœ‰çš„xmlå†…å®¹ string
        let xmlStr = Buffer.concat(postXmlData).toString("utf-8");
        // å°†xmlè½¬æ¢æˆjså¯¹è±¡ä»¥æ–¹ä¾¿æ›´å¥½çš„å»æ“ä½œ
        const xmlParser = new xml2js.Parser();
        // è§£æä¸ºxmlçš„jsonå¯¹è±¡
        let { xml } = await xmlParser.parseStringPromise(xmlStr);
        // å…¬ä¼—å¹³å°çš„idå·
        const toUserName = xml.ToUserName[0];
        // å‘é€ç»™å…¬ä¼—å¹³å°çš„å¾®ä¿¡åœ¨æ­¤å¹³å°çš„å”¯ä¸€idå€¼
        const fromUserName = xml.FromUserName[0];
        // æ¶ˆæ¯ç±»å‹ text image voice video music news
        let msgType = xml.MsgType[0];
        // å‘é€è¿‡æ¥çš„æ¶ˆæ¯å†…å®¹
        let content = xml.Content ? xml.Content[0] : "";
        // æ ¹æ®ç”¨æˆ·è¾“å…¥çš„æ•°æ®æ¥å†³å®šè¦è¿”å›ä»€ä¹ˆå†…å®¹ï¼Œæ³¨æ„è¿™é‡Œå…ˆåˆ¤æ–­ç”¨æˆ·å‘é€çš„æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œè¿™é‡Œåªæœ‰ç”¨æˆ·å‘é€æ–‡ä»¶æ—¶æ‰ä¼šè¿›è¡Œå“åº”
        if ("text" === msgType) {
          // ... ...
        } else if ("event" === msgType) {
          const event = xml.Event[0]; // è·å–äº‹ä»¶æ ‡è¯†
          if ("subscribe" === event) {
            var time = moment().format("YYYY-MM-DD hh:mm:ss");
            // æ ¹æ®fromUserName(openid: ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†)æŸ¥è¯¢æ•°æ®åº“ä¸­è¯¥ç”¨æˆ·çš„ä¿¡æ¯
            var sql = `select openid,active from wx_users where openid='${fromUserName}'`;
            // è¿™é‡Œä½¿ç”¨äº†firstï¼Œå¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°æ•°æ®åˆ™ä¼šè¿”å›undefinedï¼Œå¦‚æœæŸ¥åˆ°åˆ™ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡
            var ret = await first(sql);
            // å¦‚æœä¸ºundefinedåˆ™è¡¨ç¤ºä¸ºä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œç›´æ¥æ’å…¥æ•°æ®åº“ï¼Œå¦‚æœä¸ä¸ºundefinedåˆ™è¡¨ç¤ºä¸ºè€ç”¨æˆ·(å–æ¶ˆå…³æ³¨äº†)ï¼Œæ›´æ–°æ•°æ®åº“ä¸­çš„æ•°æ®(æ›´æ–°mtimeï¼šå†æ¬¡å…³æ³¨çš„æ—¶é—´)
            if (!ret) {
              var sql = `insert into wx_users (openid,ctime,mtime) values ('${openid}','${time}','${time}')`;
              await first(sql);
            } else {
              if (ret.active === "0") {
                var sql = `update wx_users set active='1',mtime='${time}'`;
                await first(sql);
              }
            }
            res.send(
              sendMethod(
                "text",
                fromUserName,
                toUserName,
                "ğŸ˜˜ğŸ˜˜ğŸ˜˜æ¬¢è¿å…³æ³¨æ­¤å…¬ä¼—å¹³å°,æ‚¨å°†å¾—åˆ°æ‰€æœ‰çš„å¯ç”¨çš„å‰ç«¯çŸ¥è¯†!ğŸ˜˜ğŸ˜˜ğŸ˜˜\nå›å¤\n1:å®æ—¶æ–°é—»\n2:å¨±ä¹æ–°é—»\n3:ç§‘æŠ€ä¸ç‹ æ´»"
              )
            );
          } else if ("unsubscribe" === event) {
            // æ ¹æ®fromUserNameæŠŠå½“å‰ç”¨æˆ·åœ¨æ•°æ®è¡¨ä¸­ä¿®æ”¹ä¸€ä¸‹çŠ¶æ€ active='0'
            var sql = `update wx_users set active='0' where openid='${openid}'`;
            var ret = await first(sql);
            res.send("");
          } else if ("CLICK" === event) {
            const eventKey = xml.EventKey[0];
            if ("click001" === eventKey) {
              content = "è§†é¢‘æ•™ç¨‹";
            } else {
              content = "å’¨è¯¢å°åƒ";
            }
            res.send(sendMethod("text", fromUserName, toUserName, content));
          } else {
            res.send("");
          }
        }
      });
    };
  },
};

module.exports = controller;
```

## åœºæ™¯äºŒç»´ç 

> ä¸ºäº†æ»¡è¶³ç”¨æˆ·æ¸ é“æ¨å¹¿åˆ†æå’Œç”¨æˆ·å¸å·ç»‘å®šç­‰åœºæ™¯çš„éœ€è¦ï¼Œå…¬ä¼—å¹³å°æä¾›äº†ç”Ÿæˆå¸¦å‚æ•°äºŒç»´ç çš„æ¥å£ã€‚ä½¿ç”¨è¯¥æ¥å£å¯ä»¥è·å¾—å¤šä¸ªå¸¦ä¸åŒåœºæ™¯å€¼çš„äºŒç»´ç ï¼Œç”¨æˆ·æ‰«æåï¼Œå…¬ä¼—å·å¯ä»¥æ¥æ”¶åˆ°äº‹ä»¶æ¨é€,å¹¶å¾—åˆ°åœºæ™¯å€¼ï¼Œè§£å†³å…³æ³¨æ—¶ç”¨æˆ·æ¥æºé—®é¢˜ã€‚
>
> **ç›®å‰æœ‰2ç§ç±»å‹çš„äºŒç»´ç ï¼š**
>
> - ä¸´æ—¶äºŒç»´ç ï¼Œæ˜¯æœ‰è¿‡æœŸæ—¶é—´çš„ï¼Œæœ€é•¿å¯ä»¥è®¾ç½®ä¸ºåœ¨äºŒç»´ç ç”Ÿæˆåçš„30å¤©ï¼ˆå³2592000ç§’ï¼‰åè¿‡æœŸï¼Œä½†èƒ½å¤Ÿç”Ÿæˆè¾ƒå¤šæ•°é‡ã€‚ä¸´æ—¶äºŒç»´ç ä¸»è¦ç”¨äºå¸å·ç»‘å®šç­‰ä¸è¦æ±‚äºŒç»´ç æ°¸ä¹…ä¿å­˜çš„ä¸šåŠ¡åœºæ™¯
>
> - æ°¸ä¹…äºŒç»´ç ï¼Œæ˜¯æ— è¿‡æœŸæ—¶é—´çš„ï¼Œä½†æ•°é‡è¾ƒå°‘ï¼ˆç›®å‰ä¸ºæœ€å¤š10ä¸‡ä¸ªï¼‰ã€‚æ°¸ä¹…äºŒç»´ç ä¸»è¦ç”¨äºé€‚ç”¨äºå¸å·ç»‘å®šã€ç”¨æˆ·æ¥æºç»Ÿè®¡ç­‰åœºæ™¯
>
> **è·å–åœºæ™¯äºŒç»´ç çš„æ­¥éª¤:**
>
> - é€šè¿‡access_tokenè·å–ticket(å‡­æ®)
>
> - é€šè¿‡ticket(å‡­æ®)æ¢å–äºŒç»´ç å›¾ç‰‡èµ„æº
>
> - ä¿å­˜äºŒç»´ç å›¾ç‰‡èµ„æºåˆ°è‡ªå·±æœåŠ¡å™¨ä¸­

```js
var express = require("express");
var router = express.Router();
var { getAccessToken } = require("../utils/tools");

const wechatRouter = ({ first, all }) => {
  // ... ...
  // ç”Ÿæˆåœºæ™¯ä¸´æ—¶äºŒç»´ç 
  router.get("/qr", async (req, res) => {
    let accessToken = await getAccessToken();
    // 1.ç”¨äºæ¢å–ticketå‡­æ®ï¼Œç”¨æ¥å¾—åˆ°äºŒç»´ç 
    var url = `https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=${accessToken}`;
    // action_name: "QR_SCENE"è¡¨ç¤ºä¸ºä¸´æ—¶çš„æ•´å‹å‚æ•°å€¼ï¼Œexpire_secondsè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œaction_infoè¡¨ç¤ºäºŒç»´ç è¯¦ç»†ä¿¡æ¯
    // scene_idè¡¨ç¤ºåœºæ™¯idï¼Œå¦‚æœæœ‰äººæ‰«æè¯¥ticketç”Ÿæˆçš„äºŒç»´ç å¹¶å…³æ³¨å…¬ä¼—å·ï¼Œæˆ‘ä»¬å¯ä»¥æ”¶åˆ°ä¸€ä¸ªmsgTypeä¸ºeventçš„æ¶ˆæ¯ï¼Œä»–çš„eventKeyå°±æ˜¯ç”±è¿™é‡Œçš„scene_idç»„æˆçš„å­—ç¬¦ä¸²
    const postData = { expire_seconds: 2592000, action_name: "QR_SCENE", action_info: { scene: { scene_id: 37 } } };
    let ret = await axios.post(url, postData);
    const { ticket } = ret.data;
    // 2.è·å–åœºæ™¯äºŒç»´ç çš„å›¾ç‰‡åœ°å€
    var url = `https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=${encodeURIComponent(ticket)}`;
    res.send(`<img src="${url}" />`);
  });
  // ... ...
  return router;
};

module.exports = wechatRouter;
```

> å½“æŸä¸ªç”¨æˆ·æ˜¯é€šè¿‡å¦ä¸€ä¸ªç”¨æˆ·çš„åœºæ™¯äºŒç»´ç å…³æ³¨æœ¬å…¬ä¼—å·æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ”¶åˆ°ä¸€ä¸ªmsgTypeä¸ºeventçš„æ¶ˆæ¯ï¼Œäº‹ä»¶ç±»å‹ä¸ºsubscribeï¼Œä½†æ˜¯å’Œç›´æ¥å…³æ³¨ä¸åŒçš„æ˜¯ï¼Œè¿™ç§å…³æ³¨äº‹ä»¶ä¼šæœ‰é¢å¤–çš„eventKey,è¿™ä¸ªeventKeyå€¼ä¸ºqrscene_ä¸ºå‰ç¼€ï¼Œåé¢ä¸ºäºŒç»´ç çš„å‚æ•°å€¼(action_info)ï¼Œç¤ºä¾‹ï¼š'qrscene_37'

```js
//! æ§åˆ¶å™¨ï¼Œè·¯ç”±åŒ¹é…æˆåŠŸåï¼Œç”¨ä»–æ¥å¤„ç†ä¸šåŠ¡é€»è¾‘
const sha1 = require("sha1");
const xml2js = require("xml2js");
const sendMethod = require("../msgData");
const moment = require("moment");
const token = "ilmango";

const controller = {
  // ... ...
  weChatAction(first) {
    return (req, res) => {
      let postXmlData = [];
      // postä¼ è¿‡æ¥çš„æ•°æ®éƒ½æ˜¯æ•°æ®æµï¼Œä¸èƒ½ç›´æ¥é€šè¿‡req.bodyè·å–
      req.on("data", (chunk) => postXmlData.push(chunk));
      req.on("end", async () => {
        // å¾—åˆ°å…¬ä¼—å¹³å°postå‘é€è¿‡æ¥çš„æ‰€æœ‰çš„xmlå†…å®¹ string
        let xmlStr = Buffer.concat(postXmlData).toString("utf-8");
        // å°†xmlè½¬æ¢æˆjså¯¹è±¡ä»¥æ–¹ä¾¿æ›´å¥½çš„å»æ“ä½œ
        const xmlParser = new xml2js.Parser();
        // è§£æä¸ºxmlçš„jsonå¯¹è±¡
        let { xml } = await xmlParser.parseStringPromise(xmlStr);
        // å…¬ä¼—å¹³å°çš„idå·
        const toUserName = xml.ToUserName[0];
        // å‘é€ç»™å…¬ä¼—å¹³å°çš„å¾®ä¿¡åœ¨æ­¤å¹³å°çš„å”¯ä¸€idå€¼
        const fromUserName = xml.FromUserName[0];
        // æ¶ˆæ¯ç±»å‹ text image voice video music news
        let msgType = xml.MsgType[0];
        // å‘é€è¿‡æ¥çš„æ¶ˆæ¯å†…å®¹
        let content = xml.Content ? xml.Content[0] : "";
        // æ ¹æ®ç”¨æˆ·è¾“å…¥çš„æ•°æ®æ¥å†³å®šè¦è¿”å›ä»€ä¹ˆå†…å®¹ï¼Œæ³¨æ„è¿™é‡Œå…ˆåˆ¤æ–­ç”¨æˆ·å‘é€çš„æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œè¿™é‡Œåªæœ‰ç”¨æˆ·å‘é€æ–‡ä»¶æ—¶æ‰ä¼šè¿›è¡Œå“åº”
        if ("text" === msgType) {
		  // ... ...
        } else if ("event" === msgType) {
          const event = xml.Event[0]; // è·å–äº‹ä»¶æ ‡è¯†
          if ("subscribe" === event) {
            // å½“ç”¨æˆ·é€šè¿‡åœºæ™¯äºŒç»´ç å…³æ³¨å…¬ä¼—å·æ—¶ï¼Œä¼šåœ¨ç”¨æˆ·å…³æ³¨å…¬ä¼—å·åï¼Œæ¨é€ä¸€æ¡å¸¦å‚æ•°çš„äºŒç»´ç æ‰«æäº‹ä»¶ç»™å¼€å‘è€…
            // å¦‚æœæ˜¯ç›´æ¥é€šè¿‡æœç´¢å…³æ³¨çš„ï¼Œåˆ™EventKeyæ²¡æœ‰å€¼ï¼Œå¦‚æœæ˜¯é€šè¿‡æ‰«æäºŒç»´ç å…³æ³¨çš„ï¼Œåˆ™EventKeyæœ‰å€¼
            // å€¼ä¸ºqrscene_ä¸ºå‰ç¼€ï¼Œåé¢ä¸ºäºŒç»´ç çš„å‚æ•°å€¼(action_info)ï¼Œç¤ºä¾‹ï¼š'qrscene_37'
            var qrSceneKey = xml.EventKey[0];
            // æŠŠscene_idæˆªå–å‡ºæ¥ï¼Œå¹¶è½¬æ¢ä¸ºæ•°å­—ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºnull
            let pid = qrSceneKey === "" ? null : Number(qrSceneKey.split("_")[1]);
            // ä¿å­˜å…³æ³¨æ—¶é—´ï¼Œæˆ–å†æ¬¡å…³æ³¨çš„æ—¶é—´
            var time = moment().format("YYYY-MM-DD hh:mm:ss");
            // æ ¹æ®fromUserName(openid: ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†)æŸ¥è¯¢æ•°æ®åº“ä¸­è¯¥ç”¨æˆ·çš„ä¿¡æ¯
            var sql = `select openid,active from wx_users where openid='${fromUserName}'`;
            // è¿™é‡Œä½¿ç”¨äº†firstï¼Œå¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°æ•°æ®åˆ™ä¼šè¿”å›undefinedï¼Œå¦‚æœæŸ¥åˆ°åˆ™ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡
            var ret = await first(sql);
            // å¦‚æœä¸ºundefinedåˆ™è¡¨ç¤ºä¸ºä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œç›´æ¥æ’å…¥æ•°æ®åº“ï¼Œå¦‚æœä¸ä¸ºundefinedåˆ™è¡¨ç¤ºä¸ºè€ç”¨æˆ·(å–æ¶ˆå…³æ³¨äº†)ï¼Œæ›´æ–°æ•°æ®åº“ä¸­çš„æ•°æ®(æ›´æ–°mtimeï¼šå†æ¬¡å…³æ³¨çš„æ—¶é—´)
            if (!ret) {
              // å¦‚æœæ˜¯ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œå¹¶ä¸”æ²¡æœ‰pid(è¡¨ç¤ºæ˜¯ç›´æ¥é€šè¿‡æœç´¢å…³æ³¨çš„)ï¼Œåˆ™ç›´æ¥æ’å…¥æ•°æ®åº“
              // è€Œå¦‚æœæ˜¯ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œå¹¶ä¸”æœ‰pid(è¡¨ç¤ºæ˜¯é€šè¿‡æ‰«æäºŒç»´ç å…³æ³¨çš„)ï¼Œè¿™æ ·çš„è¯å°±éœ€è¦æ ¹æ®pidæŸ¥è¯¢æ•°æ®åº“ä¸­çš„ç”¨æˆ·ä¿¡æ¯(è¯¥ç”¨æˆ·æ˜¯è°é‚€è¯·çš„)
              // ç„¶åæŠŠè¯¥ç”¨æˆ·çš„idä½œä¸ºä¸€çº§æ¨èäººï¼Œå¹¶æŠŠè¯¥ç”¨æˆ·çš„ä¸€çº§æ¨èäººä½œä¸ºäºŒçº§æ¨èäººï¼ŒäºŒçº§æ¨èäººä½œä¸ºä¸‰çº§æ¨èäººï¼Œç„¶åæ’å…¥æ•°æ®åº“(æœ€é«˜ä¸‰çº§æ¨èäººï¼Œå†å¤šå°±è¿æ³•äº†)
              // åœ¨çœŸå®ä¸šåŠ¡ä¸­ï¼Œä¼šæ ¹æ®åˆ†é”€äººå‘˜çš„ç­‰çº§æ¥åˆ†é…å¥½å¤„ï¼Œæ¯”å¦‚ä¸€çº§æ¨èäººå¯ä»¥è·å¾—10%çš„ä½£é‡‘ï¼ŒäºŒçº§æ¨èäººå¯ä»¥è·å¾—5%çš„ä½£é‡‘ï¼Œä¸‰çº§æ¨èäººå¯ä»¥è·å¾—2%çš„ä½£é‡‘
              // å¦‚æœæŸä¸ªç”¨æˆ·æ²¡æœ‰æ¨èäººï¼Œåˆ™å®ƒå¯ä»¥è·å–æ‰€æœ‰çš„ä½£é‡‘
              if (!null) {
                var sql = `insert into wx_users (openid,ctime,mtime) values ('${openid}','${time}','${time}')`;
                await first(sql);
              } else {
                var sql = `select openid,level1,level2 from wx_users where id=${pid}`;
                var userinfo = await first(sql);
                var sql = `insert into wx_users (openid,ctime,mtime,level1,level2,level3) values ('${openid}','${time}','${time}','${userinfo.openid}','${userinfo.l1}','${userinfo.l2}')`;
                await first(sql);
              }
            } else {
              if (ret.active === "0") {
                var sql = `update wx_users set active='1',mtime='${time}'`;
                await first(sql);
              }
            }
            res.send(
              sendMethod(
                "text",
                fromUserName,
                toUserName,
                "ğŸ˜˜ğŸ˜˜ğŸ˜˜æ¬¢è¿å…³æ³¨æ­¤å…¬ä¼—å¹³å°,æ‚¨å°†å¾—åˆ°æ‰€æœ‰çš„å¯ç”¨çš„å‰ç«¯çŸ¥è¯†!ğŸ˜˜ğŸ˜˜ğŸ˜˜\nå›å¤\n1:å®æ—¶æ–°é—»\n2:å¨±ä¹æ–°é—»\n3:ç§‘æŠ€ä¸ç‹ æ´»"
              )
            );
          } else if ("unsubscribe" === event) {
            // æ ¹æ®openidæŠŠå½“å‰ç”¨æˆ·åœ¨æ•°æ®è¡¨ä¸­ä¿®æ”¹ä¸€ä¸‹çŠ¶æ€ active='0'
            var sql = `update wx_users set active='0' where openid='${openid}'`;
            var ret = await first(sql);
            res.send("");
          } else if ("CLICK" === event) {
            const eventKey = xml.EventKey[0];
            if ("click001" === eventKey) {
              content = "è§†é¢‘æ•™ç¨‹";
            } else {
              content = "å’¨è¯¢å°åƒ";
            }
            res.send(sendMethod("text", fromUserName, toUserName, content));
          } else {
            res.send("");
          }
        }
      });
    };
  },
};

module.exports = controller;
```

## ç½‘é¡µæˆæƒ

> å…¬ä¼—å·åå°å¯ä»¥é€šè¿‡è®¾ç½®æˆæƒåŸŸåï¼Œç„¶åé€šè¿‡æ­¤åŸŸåç”Ÿæˆç›¸åº”çš„é“¾æ¥ï¼Œåˆ†äº«åˆ°æœ‹å‹åœˆï¼Œå¥½å‹ç­‰ï¼Œç”¨æˆ·é€šè¿‡å¾®ä¿¡å®¢æˆ·ç«¯æ¥ç‚¹å‡»è®¿é—®æ­¤é“¾æ¥ï¼Œå…¬ä¼—å¹³å°å°±å¯ä»¥è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼Œè¿›è€Œå®ç°ä¸šåŠ¡é€»è¾‘ã€‚
>
> åº”ç”¨åœºæ™¯ï¼šé—®å·è°ƒæŸ¥ã€ åœ¨çº¿æŠ•ç¥¨ç­‰

### ç½‘é¡µæˆæƒæµç¨‹

<img src="https://cdn.jsdelivr.net/gh/ilmangoi/imgRepo@main/img/fasdfadsafhgf.png" alt="fasdfadsafhgf" style="zoom:67%;" />

### è®¾ç½®å¾®ä¿¡æˆæƒåŸŸå

<img src="https://cdn.jsdelivr.net/gh/ilmangoi/imgRepo@main/img/jytjrtyj.png" alt="jytjrtyj" style="zoom:67%;" />

<img src="https://cdn.jsdelivr.net/gh/ilmangoi/imgRepo@main/img/nyrthfghfgd.png" alt="nyrthfghfgd" style="zoom:67%;" />

### å¾®ä¿¡æˆæƒä»£ç å®ç°

> å®ç°ç½‘é¡µæˆæƒï¼Œå…¬ä¼—å¹³å°ç»™æˆ‘ä»¬æä¾›2ç§æƒé™(å…³äºç½‘é¡µæˆæƒçš„ä¸¤ç§scopeçš„åŒºåˆ«è¯´æ˜)ï¼š
>
> 1. ä»¥snsapi_baseä¸ºscopeå‘èµ·çš„ç½‘é¡µæˆæƒï¼Œæ˜¯ç”¨æ¥è·å–è¿›å…¥é¡µé¢çš„ç”¨æˆ·çš„openidçš„ï¼Œå¹¶ä¸”æ˜¯é™é»˜æˆæƒå¹¶è‡ªåŠ¨è·³è½¬åˆ°å›è°ƒé¡µçš„ã€‚ç”¨æˆ·æ„ŸçŸ¥çš„å°±æ˜¯ç›´æ¥è¿›å…¥äº†å›è°ƒé¡µï¼ˆå¾€å¾€æ˜¯ä¸šåŠ¡é¡µé¢ï¼‰
>
> 2. ä»¥snsapi_userinfoä¸ºscopeå‘èµ·çš„ç½‘é¡µæˆæƒï¼Œæ˜¯ç”¨æ¥è·å–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯çš„ã€‚ä½†è¿™ç§æˆæƒéœ€è¦ç”¨æˆ·æ‰‹åŠ¨åŒæ„ï¼Œå¹¶ä¸”ç”±äºç”¨æˆ·åŒæ„è¿‡ï¼Œæ‰€ä»¥æ— é¡»å…³æ³¨ï¼Œå°±å¯åœ¨æˆæƒåè·å–è¯¥ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€‚

**ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·åŒæ„æˆæƒï¼Œè·å–code**

> åœ¨ç¡®ä¿å¾®ä¿¡å…¬ä¼—è´¦å·æ‹¥æœ‰æˆæƒä½œç”¨åŸŸï¼ˆscopeå‚æ•°ï¼‰çš„æƒé™çš„å‰æä¸‹ï¼ˆå·²è®¤è¯æœåŠ¡å·ï¼Œé»˜è®¤æ‹¥æœ‰ scope å‚æ•°ä¸­çš„snsapi_baseå’Œsnsapi_userinfo æƒé™ï¼‰ï¼Œå¼•å¯¼å…³æ³¨è€…æ‰“å¼€å¦‚ä¸‹é¡µé¢ï¼š

> scopeä¸ºsnsapi_baseï¼š
>
> https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx520c15f417810387&redirect_uri=https%3A%2F%2Fchong.qq.com%2Fphp%2Findex.php%3Fd%3D%26c%3DwxAdapter%26m%3DmobileDeal%26showwxpaytitle%3D1%26vb2ctag%3D4_2030_5_1194_60&response_type=code&scope=snsapi_base&state=123#wechat_redirect
>
> **scopeä¸ºsnsapi_userinfoï¼š**
>
> https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxf0e81c3bee622d60&redirect_uri=http%3A%2F%2Fnba.bluewebgame.com%2Foauth_response.php&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect

| å‚æ•°             | æ˜¯å¦å¿…é¡» | è¯´æ˜                                                         |
| :--------------- | :------- | ------------------------------------------------------------ |
| appid            | æ˜¯       | å…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†                                             |
| redirect_uri     | æ˜¯       | æˆæƒåé‡å®šå‘çš„å›è°ƒé“¾æ¥åœ°å€ï¼Œ è¯·ä½¿ç”¨ urlEncode å¯¹é“¾æ¥è¿›è¡Œå¤„ç† |
| response_type    | æ˜¯       | è¿”å›ç±»å‹ï¼Œè¯·å¡«å†™code                                         |
| scope            | æ˜¯       | åº”ç”¨æˆæƒä½œç”¨åŸŸï¼Œsnsapi_base ï¼ˆä¸å¼¹å‡ºæˆæƒé¡µé¢ï¼Œç›´æ¥è·³è½¬ï¼Œåªèƒ½è·å–ç”¨æˆ·openidï¼‰ï¼Œsnsapi_userinfo ï¼ˆå¼¹å‡ºæˆæƒé¡µé¢ï¼Œå¯é€šè¿‡ openid æ‹¿åˆ°æ˜µç§°ã€æ€§åˆ«ã€æ‰€åœ¨åœ°ã€‚å¹¶ä¸”ï¼Œ å³ä½¿åœ¨æœªå…³æ³¨çš„æƒ…å†µä¸‹ï¼Œåªè¦ç”¨æˆ·æˆæƒï¼Œä¹Ÿèƒ½è·å–å…¶ä¿¡æ¯ ï¼‰ |
| state            | å¦       | é‡å®šå‘åä¼šå¸¦ä¸Š state å‚æ•°ï¼Œå¼€å‘è€…å¯ä»¥å¡«å†™a-zA-Z0-9çš„å‚æ•°å€¼ï¼Œæœ€å¤š128å­—èŠ‚ |
| #wechat_redirect | æ˜¯       | æ— è®ºç›´æ¥æ‰“å¼€è¿˜æ˜¯åšé¡µé¢302é‡å®šå‘æ—¶å€™ï¼Œå¿…é¡»å¸¦æ­¤å‚æ•°            |
| forcePopup       | å¦       | å¼ºåˆ¶æ­¤æ¬¡æˆæƒéœ€è¦ç”¨æˆ·å¼¹çª—ç¡®è®¤ï¼›é»˜è®¤ä¸ºfalseï¼›éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‹¥ç”¨æˆ·å‘½ä¸­äº†ç‰¹æ®Šåœºæ™¯ä¸‹çš„é™é»˜æˆæƒé€»è¾‘ï¼Œåˆ™æ­¤å‚æ•°ä¸ç”Ÿæ•ˆ |

**ç¬¬äºŒæ­¥ï¼šé€šè¿‡codeæ¢å–ç½‘é¡µæˆæƒaccess_tokenå’Œopenid**

å¦‚æœç”¨æˆ·åŒæ„æˆæƒï¼Œé¡µé¢å°†è·³è½¬è‡³ redirect_uri/?code=CODE&state=STATEï¼Œcodeä½œä¸ºæ¢å–access_tokençš„ç¥¨æ®ï¼Œæ¯æ¬¡ç”¨æˆ·æˆæƒå¸¦ä¸Šçš„ code å°†ä¸ä¸€æ ·ï¼Œcodeåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œ5åˆ†é’Ÿæœªè¢«ä½¿ç”¨è‡ªåŠ¨è¿‡æœŸ

> å…³äºç½‘é¡µæˆæƒaccess_tokenå’Œæ™®é€šaccess_tokençš„åŒºåˆ«
>
> 1. å¾®ä¿¡ç½‘é¡µæˆæƒæ˜¯é€šè¿‡OAuth2.0æœºåˆ¶å®ç°çš„ï¼Œåœ¨ç”¨æˆ·æˆæƒç»™å…¬ä¼—å·åï¼Œå…¬ä¼—å·å¯ä»¥è·å–åˆ°ä¸€ä¸ªç½‘é¡µæˆæƒç‰¹æœ‰çš„æ¥å£è°ƒç”¨å‡­è¯ï¼ˆç½‘é¡µæˆæƒaccess_tokenï¼‰ï¼Œé€šè¿‡ç½‘é¡µæˆæƒaccess_tokenå¯ä»¥è¿›è¡Œæˆæƒåæ¥å£è°ƒç”¨ï¼Œå¦‚è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
> 2. å…¶ä»–å¾®ä¿¡æ¥å£ï¼Œéœ€è¦é€šè¿‡åŸºç¡€æ”¯æŒä¸­çš„â€œè·å–access_tokenâ€æ¥å£æ¥è·å–åˆ°çš„æ™®é€šaccess_tokenè°ƒç”¨

```js
const router = require("express").Router();
const { getAccessToken } = require("../utils/tools");

const appid = "wxae077dbd6d0b42b8";
const secret = "12692272e71906eacbdde9e3023e3062";

const wechatRouter = ({ first, all }) => {
  // ... ...
  // ç”Ÿæˆæˆæƒç½‘å€
  router.get("/createAuthUrl_base", async (req, res) => {
    // æˆæƒåé‡å®šå‘çš„ç½‘å€ï¼Œè¿™é‡Œå¿…é¡»ä½¿ç”¨uriç¼–ç è½¬ä¹‰ä¸€ä¸‹ç‰¹æ®Šå­—ç¬¦
    let redirect_uri = encodeURIComponent(req.query.redirect_uri);
    var url = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appid}&redirect_uri=${redirect_uri}&response_type=code&scope=snsapi_base&state=10000#wechat_redirect`;
    res.send(url);
  });

  // æˆæƒåé‡å®šå‘åˆ°çš„ç½‘å€
  router.get("/vote", async (req, res) => {
    // åœ¨queryä¸­è·å–åˆ°codeå€¼
    let { code } = req.query;
    // é€šè¿‡codeå€¼å»å‘å…¬ä¼—å¹³å°è¦ç”¨æˆ·ä¿¡æ¯(openidå’Œaccess_token)
    let url = `https://api.weixin.qq.com/sns/oauth2/access_token?appid=${appid}&secret=${secret}&code=${code}&grant_type=authorization_code`;
    let ret = await axios.get(url);
    res.send(ret.data.openid + "");
  });

  return router;
};

module.exports = wechatRouter;
```

**æ‹‰å–ç”¨æˆ·ä¿¡æ¯(éœ€scopeä¸º snsapi_userinfo)**

> è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶ä¼ é€’ç»™å‰ç«¯é¡µé¢ï¼Œè¿™é‡Œä½¿ç”¨ssrè¿›è¡Œæ¸²æŸ“ï¼Œå› æ­¤éœ€è¦å®‰è£…æ¨¡æ¿å¼•æ“
>
> å¹¶ä¸”ä¸ºäº†ä¿æŒç”¨æˆ·æ•°æ®(é¿å…é‡å¤è¯·æ±‚)ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨sessionæ¥å®Œæˆ
>
> ```js
> npm install express-art-template --save
> npm install cookie-session --save
> ```

- **/app.js**

> é…ç½®art-templateå’Œcookie-session

```js
var session = require("cookie-session"); // å¯¼å…¥cookie-sessionæ¨¡å—

// é‡åˆ°artåç¼€çš„æ–‡ä»¶ä½¿ç”¨art-templateè¿›è¡Œè§£æ
app.engine("art", require("express-art-template"));
// res.renderæ¸²æŸ“çš„æ¨¡æ¿é»˜è®¤å­˜å‚¨ä½ç½®
app.set("views", path.join(__dirname, "views"));
// res.renderæ¸²æŸ“çš„æ¨¡æ¿é»˜è®¤çš„åç¼€å
app.set("view engine", "art");
// sessioné…ç½®
app.use(
  session({
    name: "session_id",
    secret: "tRyw6vU!iMnzHD4x8jTxCXS7RjGiPhq31exwD2X0O$u7vrBULT$&JsgGUW&EE$4jbBFQAArPdmW18WA4c1kOe8*4NCYbZ2ZErW^",
  })
);
```

- **/routes/weChat.js**

> ç”Ÿæˆæˆæƒåœ°å€ï¼Œç”¨æˆ·åŒæ„æˆæƒåï¼Œå³å¯åœ¨é‡å®šå‘åœ°å€ä¸­çš„queryä¸­å¾—åˆ°codeï¼Œç„¶åå°±å¯ä»¥æ‹¿ç€codeå»è·å–ç”¨æˆ·access-tokenï¼Œæœ€åæ‹¿ç€ç”¨æˆ·access-tokenå»å¾—åˆ°ç”¨æˆ·ä¿¡æ¯

```js
const router = require("express").Router();
const { getAccessToken } = require("../utils/tools");

const appid = "wxae077dbd6d0b42b8";
const secret = "12692272e71906eacbdde9e3023e3062";

const wechatRouter = ({ first, all }) => {
  // ... ...
  // ç”Ÿæˆæˆæƒç½‘å€
  router.get("/createAuthUrl_base", async (req, res) => {
    // æˆæƒåé‡å®šå‘çš„ç½‘å€ï¼Œè¿™é‡Œå¿…é¡»ä½¿ç”¨uriç¼–ç è½¬ä¹‰ä¸€ä¸‹ç‰¹æ®Šå­—ç¬¦
    let redirect_uri = encodeURIComponent(req.query.redirect_uri);
    var url = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appid}&redirect_uri=${redirect_uri}&response_type=code&scope=snsapi_base&state=10000#wechat_redirect`;
    res.send(url);
  });

  // æˆæƒåé‡å®šå‘åˆ°çš„ç½‘å€
  router.get("/vote_userinfo", async (req, res) => {
    // é€šè¿‡codeå€¼å»å‘å…¬ä¼—å¹³å°è¦ç”¨æˆ·ä¿¡æ¯(openidå’Œaccess_token)
    let { code } = req.query;
    // å¦‚æœæ²¡æœ‰sessionæ•°æ®æ—¶æ‰å»é‡æ–°è¯·æ±‚ç”¨æˆ·æ•°æ®
    if (!req.session.openid) {
      var url = `https://api.weixin.qq.com/sns/oauth2/access_token?appid=${appid}&secret=${secret}&code=${code}&grant_type=authorization_code`;
      var ret = await axios.get(url);
      let { openid, access_token } = ret.data;

      // å¦‚æœæˆæƒæ˜¯userinfoæ¨¡å¼ï¼Œåˆ™å¯ä»¥é€šè¿‡è¯·æ±‚åˆ°çš„ç”¨æˆ·access_tokenæ¥æ‹‰å–ç”¨æˆ·ä¿¡æ¯
      var url = `https://api.weixin.qq.com/sns/userinfo?access_token=${access_token}&openid=${openid}&lang=zh_CN`;
      var ret = await axios.get(url);
      let { nickname, headimgurl } = ret.data; // è§£æ„ç”¨æˆ·åå’Œå¤´åƒurl

      // å¾—åˆ°çš„æ•°æ®ï¼Œå­˜å‚¨åœ¨sessionä¸­ï¼Œç”¨äºå½“å‰ä¼šè¯ä¿¡æ¯çš„ä¿æŒï¼Œsessionæ˜¯ç”¨äºåœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“æ—¶ï¼Œä¿æŒç”¨æˆ·çŠ¶æ€çš„æ–¹æ¡ˆ
      req.session.openid = openid;
      req.session.nickname = nickname;
      req.session.headimgurl = headimgurl;
    }

    // å‚æ•°1ï¼šæŒ‡å®šviewsç›®å½•ä¸‹é¢çš„æ–‡ä»¶
    // å‚æ•°2ï¼šç»™æ¨¡æ¿èµ‹çš„å€¼ï¼ˆé€šè¿‡å°èƒ¡å­è¯·æ±‚è·å–ï¼‰
    res.render("vote.art", {
      openid: req.session.openid,
      nickname: req.session.nickname,
      headimgurl: req.session.headimgurl,
    });
  });
  return router;
};

module.exports = wechatRouter;
```

- **/views/vote.art**

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- ç§»åŠ¨ç«¯å¼€å‘æ—¶ï¼Œæ­¤å£°æ˜ä¸€å®šè¦æœ‰ -->
  <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>æŠ•ç¥¨ä¸€ä¸‹</title>
</head>

<body>
  <h3><span id="nickname">{{nickname}}</span> ---- {{openid}}</h3>
  <img src="{{headimgurl}}" alt="">
</body>

</html>
```

## å¾®ä¿¡JS-SDK

### ä»€ä¹ˆæ˜¯JS-SDK

> JS-SDKå°±æ˜¯å¾®ä¿¡å¸®åŠ©æˆ‘ä»¬å®Œæˆçš„JSä¸€ä¸ªå·¥å…·çš„å°è£…ï¼Œç›´æ¥è°ƒç”¨è¿™äº›æ¥å£å°±å¯ä»¥å®Œæˆç›¸åº”çš„åŠŸèƒ½ã€‚JS-SDKå¿…é¡»åœ¨å¾®ä¿¡ç¯å¢ƒä¸‹æ‰å¯ä»¥ç”¨ï¼Œä¸èƒ½åœ¨æµè§ˆå™¨ç›´æ¥ä½¿ç”¨ã€‚é€šè¿‡ä½¿ç”¨å¾®ä¿¡JS-SDKï¼Œç½‘é¡µå¼€å‘è€…å¯å€ŸåŠ©å¾®ä¿¡é«˜æ•ˆåœ°ä½¿ç”¨æ‹ç…§ã€é€‰å›¾ã€è¯­éŸ³ã€ä½ç½®ç­‰æ‰‹æœºç³»ç»Ÿçš„èƒ½åŠ›ï¼ŒåŒæ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨å¾®ä¿¡åˆ†äº«ã€æ‰«ä¸€æ‰«ã€å¡åˆ¸ã€æ”¯ä»˜ç­‰å¾®ä¿¡ç‰¹æœ‰çš„èƒ½åŠ›ï¼Œä¸ºå¾®ä¿¡ç”¨æˆ·æä¾›æ›´ä¼˜è´¨çš„ç½‘é¡µä½“éªŒã€‚è¿˜å¯ä»¥ä½¿ç”¨å®ƒè‡ªå®šä¹‰åˆ†äº«çš„é“¾æ¥(æ­¤é“¾æ¥å¿…é¡»ä¸å…¬ä¼—åå°æœ‰æ•ˆåŸŸåä¸€è‡´)
>
> **æ­¥éª¤ï¼š**
>
> - å¹³å°ç»‘å®šæˆæƒåŸŸå
>
> - å¼•å…¥å…¬ä¼—å¹³å°jssdkçš„jsæ–‡ä»¶
>
> - æ ¹æ®å®˜æ–¹ç­¾åç®—æ³•ç¼–å†™å‡ºå¯¹åº”çš„ç­¾åå­—ç¬¦ä¸²
>
> - è®¾ç½®å‰å°scriptä¸­çš„configæ¥å£é…ç½®æ³¨å…¥æƒé™éªŒè¯
>
> - é€šè¿‡å‰å°scriptä¸­çš„æ¥å£æä¾›çš„ready(æˆåŠŸ)/error(å¤±è´¥)æ–¹æ³•å¤„ç†

### JS-SDKä½¿ç”¨æµç¨‹

**æ­¥éª¤ä¸€ï¼šç»‘å®šåŸŸå**

> ä¸é…ç½®ç½‘é¡µæˆæƒåŸŸåç±»ä¼¼ï¼Œè¿™é‡Œçš„åŸŸåä¸éœ€è¦å†™åè®®ï¼Œä¾‹å¦‚ï¼šr7b4y4.natappfree.cc

<img src="https://cdn.jsdelivr.net/gh/ilmangoi/imgRepo@main/img/Snipaste_2022-10-26_08-34-31.png" alt="Snipaste_2022-10-26_08-34-31" style="zoom:67%;" />

**æ­¥éª¤äºŒï¼šå¼•å…¥ JS æ–‡ä»¶**

åœ¨éœ€è¦è°ƒç”¨ JS æ¥å£çš„é¡µé¢å¼•å…¥å¦‚ä¸‹ JS æ–‡ä»¶ï¼ˆæ”¯æŒhttpsï¼Œè¯¦è§å®˜ç½‘ï¼‰ï¼š

http://res.wx.qq.com/open/js/jweixin-1.6.0.js

**æ­¥éª¤ä¸‰: æ ¹æ®å®˜æ–¹ç­¾åç®—æ³•ç¼–å†™å‡ºå¯¹åº”çš„ç­¾åå­—ç¬¦ä¸²**

- **/routes/weChat.js**

```js
var express = require("express");
var router = express.Router();
var { getAccessToken } = require("../utils/tools");
var sha1 = require("sha1");


// æµ‹è¯•å·ä¿¡æ¯ï¼Œç”¨äºè¯·æ±‚å¾®ä¿¡å…¬ä¼—å¹³å°çš„å‡­æ®
const appid = "wxef51ed34ca2cbf3c";
const secret = "8ff5ba423003a7f2a3a30b7aeaa01e02";

const weChatRouter = ({ first, all }) => {
  // ... ...
  // åœ¨æœåŠ¡å™¨ç«¯ç”Ÿæˆjssdkæ‰€éœ€è¦çš„configé…ç½®ä¿¡æ¯
  router.post("/jsSdkConfig", async (req, res) => {
    // è·å–access_token
    let accessToken = await getAccessToken();
    // è·å–jsapi_ticketï¼Œjsapi_ticketæ˜¯å…¬ä¼—å·ç”¨äºè°ƒç”¨å¾®ä¿¡ JS æ¥å£çš„ä¸´æ—¶ç¥¨æ®
    // æ­£å¸¸æƒ…å†µä¸‹ï¼Œjsapi_ticketçš„æœ‰æ•ˆæœŸä¸º7200ç§’ï¼Œé€šè¿‡access_tokenæ¥è·å–
    var url = `https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=${accessToken}&type=jsapi`;
    var ret = await axios.get(url);
    const { ticket } = ret.data;
    // ç”Ÿæˆæ—¶é—´æˆ³
    const timestamp = Math.floor(Date.now() / 1000);
    // è¦æŠŠå‰ç«¯ä¼ æ¥çš„urlè¿›è¡Œè§£ç ï¼Œå› ä¸ºå‰ç«¯ä¼ æ¥çš„urlæ˜¯ç»è¿‡ç¼–ç çš„
    // æ³¨æ„ï¼šurlå¿…é¡»æ˜¯æ­¥éª¤ä¸€ä¸­ç»‘å®šçš„åŸŸåï¼Œå¦åˆ™ä¼šéªŒè¯å¤±è´¥
    var url = decodeURIComponent(req.body.url);
    // ç”Ÿæˆç­¾åçš„éšæœºå­—ç¬¦ä¸²
    const noncestr = "Wm3WZYTPz0wzccnW";
    // å‚ä¸ç­¾åçš„å­—æ®µåŒ…æ‹¬noncestrï¼ˆéšæœºå­—ç¬¦ä¸²ï¼‰, æœ‰æ•ˆçš„jsapi_ticket, timestampï¼ˆæ—¶é—´æˆ³ï¼‰, urlï¼ˆå½“å‰ç½‘é¡µçš„URLï¼Œä¸åŒ…å«#åŠå…¶åé¢éƒ¨åˆ†ï¼‰
    // å¯¹æ‰€æœ‰å¾…ç­¾åå‚æ•°æŒ‰ç…§å­—æ®µåçš„ASCII ç ä»å°åˆ°å¤§æ’åºï¼ˆå­—å…¸åºï¼‰åï¼Œä½¿ç”¨ URL é”®å€¼å¯¹çš„æ ¼å¼ï¼ˆå³key1=value1&key2=value2â€¦ï¼‰æ‹¼æ¥æˆå­—ç¬¦ä¸²string1
    // è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æ‰€æœ‰å‚æ•°åå‡ä¸ºå°å†™å­—ç¬¦ã€‚å¯¹string1ä½œsha1åŠ å¯†ï¼Œå­—æ®µåå’Œå­—æ®µå€¼éƒ½é‡‡ç”¨åŸå§‹å€¼ï¼Œä¸è¿›è¡ŒURL è½¬ä¹‰
    const signature = sha1(`jsapi_ticket=${ticket}&noncestr=${noncestr}&timestamp=${timestamp}&url=${url}`);

    res.send({
      appid,
      timestamp,
      noncestr,
      signature,
    });
  });

  return router;
};

module.exports = weChatRouter;
```

**æ­¥éª¤å››ï¼šé€šè¿‡ config æ¥å£æ³¨å…¥æƒé™éªŒè¯é…ç½®**

- **/views/template.art**

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script> // å¼•å…¥js-sdk
</head>

<body>
  <script>
    fetch('/jsSdkConfig', {
      method: 'post',
      // ç”±äºurlä¸­æœ‰&ç¬¦å·ï¼Œæ‰€ä»¥éœ€è¦è½¬ä¹‰ï¼Œé˜²æ­¢æœ‰æ­§ä¹‰ï¼Œåç«¯è§£æé”™è¯¯
      // url=http://r7b4y4.natappfree.cc/share?code=021YaZ00011cOO12Vr300Mh3kD4YaZ0L&state=10000
      body: `url=${encodeURIComponent(location.href)}`,
      headers: {
        'content-type': 'application/x-www-form-urlencoded' // æŒ‡å®šbodyæ•°æ®ä¸ºurlæ ¼å¼(a=b&c=d)
      }
    }).then(ret => ret.json()).then(({
      appid,
      timestamp,
      noncestr,
      signature
    }) => {
      wx.config({
        debug: false,
        appId: appid, // å¿…å¡«ï¼Œå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
        timestamp: timestamp, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
        nonceStr: noncestr, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
        signature,// å¿…å¡«ï¼Œç­¾å
        jsApiList: [] // å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„ JS æ¥å£åˆ—è¡¨(å°±æ˜¯å¯¹åº”çš„wx.æ–¹æ³•åç§°)
      });
    })

    // configä¿¡æ¯éªŒè¯åä¼šæ‰§è¡Œ ready æ–¹æ³•ï¼Œæ‰€æœ‰æ¥å£è°ƒç”¨éƒ½å¿…é¡»åœ¨ config æ¥å£è·å¾—ç»“æœä¹‹åï¼Œconfigæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„å¼‚æ­¥æ“ä½œ
    // æ‰€ä»¥å¦‚æœéœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶å°±è°ƒç”¨ç›¸å…³æ¥å£ï¼Œåˆ™é¡»æŠŠç›¸å…³æ¥å£æ”¾åœ¨ ready å‡½æ•°ä¸­è°ƒç”¨æ¥ç¡®ä¿æ­£ç¡®æ‰§è¡Œ
    // å¯¹äºç”¨æˆ·è§¦å‘æ—¶æ‰è°ƒç”¨çš„æ¥å£ï¼Œåˆ™å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œä¸éœ€è¦æ”¾åœ¨ ready å‡½æ•°ä¸­
    wx.ready(function () {});
    // configä¿¡æ¯éªŒè¯å¤±è´¥ä¼šæ‰§è¡Œ error å‡½æ•°ï¼Œå¦‚ç­¾åè¿‡æœŸå¯¼è‡´éªŒè¯å¤±è´¥ï¼Œå…·ä½“é”™è¯¯ä¿¡æ¯å¯ä»¥æ‰“å¼€ config çš„debugæ¨¡å¼æŸ¥çœ‹
    // ä¹Ÿå¯ä»¥åœ¨è¿”å›çš„ res å‚æ•°ä¸­æŸ¥çœ‹ï¼Œå¯¹äº SPA å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°ç­¾å
    wx.error(function(res) {});
  </script>
</body>

</html>
```

### ç ä»·æ¡ˆä¾‹

> è¿™ä¸ªæ¡ˆä¾‹æœ€éš¾çš„éƒ¨åˆ†å°±æ˜¯è€ƒè™‘å¦‚ä½•æŠŠä½ çš„openidå’Œç»™ä½ ç ä»·çš„äººçš„openidä¼ è¿›åŒä¸€ä¸ªé¡µé¢ä¸­ã€‚è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š
>
> - ç”¨æˆ·å…ˆè¿›å…¥shareé¡µé¢ï¼Œä½†æ˜¯è¿™é‡Œçš„ä¸æ˜¯ç›´æ¥è¿›å…¥shareé¡µé¢ï¼Œè€Œæ˜¯é€šè¿‡æˆæƒç½‘å€ï¼Œé€šè¿‡æˆæƒåé‡å®šå‘è¿›shareé¡µé¢
> - è¿™æ ·å°±å¯ä»¥è·å–åˆ°ç”¨æˆ·çš„openidï¼Œè¿™é‡Œå°±é€šè¿‡ssræŠŠé¡µé¢æ¸²æŸ“å‡ºæ¥ï¼Œå¹¶æŠŠopenidä¼ ç»™é¡µé¢
> - shareé¡µé¢ä¸­é…ç½®äº†js-sdkçš„è‡ªå®šä¹‰åˆ†äº«æ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯çš„urlä¼šæŒ‡å‘æˆæƒé¡µé¢ï¼Œå¹¶ä¸”ä¼ é€’çš„stateä¸ºopenid
> - è¯¥æˆæƒé¡µé¢çš„é‡å®šå‘åœ°å€æ˜¯bargainé¡µé¢ï¼Œè¿™ä¸ªé¡µé¢ç»è¿‡æˆæƒåå°±å¯ä»¥è·å–åˆ°ç ä»·ç”¨æˆ·çš„openid
> - è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åŒæ—¶è·å–åˆ°ä¸¤è€…çš„openid

- **/routes/weChat.js**

```js
var express = require("express");
var router = express.Router();
var { getAccessToken } = require("../utils/tools");
var sha1 = require("sha1");

// æµ‹è¯•å·ä¿¡æ¯ï¼Œç”¨äºè¯·æ±‚å¾®ä¿¡å…¬ä¼—å¹³å°çš„å‡­æ®
const appid = "wxef51ed34ca2cbf3c";
const secret = "8ff5ba423003a7f2a3a30b7aeaa01e02";

const weChatRouter = ({ first, all }) => {
  // ... ...
  // ç”Ÿæˆæˆæƒç½‘å€
  router.get("/createAuthUrl", async (req, res) => {
    // æˆæƒåé‡å®šå‘çš„ç½‘å€ï¼Œè¿™é‡Œå¿…é¡»ä½¿ç”¨uriç¼–ç è½¬ä¹‰ä¸€ä¸‹ç‰¹æ®Šå­—ç¬¦
    let redirect_uri = encodeURIComponent(req.query.redirect_uri) || "http://www.baidu.com";
    let state = req.query.state || "STATE";
    var url = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appid}&redirect_uri=${redirect_uri}&response_type=code&scope=snsapi_base&state=${state}#wechat_redirect`;
    res.send(url);
  });

  // åœ¨æœåŠ¡å™¨ç«¯ç”Ÿæˆjssdkæ‰€éœ€è¦çš„configé…ç½®ä¿¡æ¯
  router.post("/jsSdkConfig", async (req, res) => {
    // è·å–access_token
    let accessToken = await getAccessToken();
    // è·å–jsapi_ticketï¼Œjsapi_ticketæ˜¯å…¬ä¼—å·ç”¨äºè°ƒç”¨å¾®ä¿¡ JS æ¥å£çš„ä¸´æ—¶ç¥¨æ®
    // æ­£å¸¸æƒ…å†µä¸‹ï¼Œjsapi_ticketçš„æœ‰æ•ˆæœŸä¸º7200ç§’ï¼Œé€šè¿‡access_tokenæ¥è·å–
    var url = `https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=${accessToken}&type=jsapi`;
    var ret = await axios.get(url);
    const { ticket } = ret.data;
    // ç”Ÿæˆæ—¶é—´æˆ³
    const timestamp = Math.floor(Date.now() / 1000);
    // è¦æŠŠå‰ç«¯ä¼ æ¥çš„urlè¿›è¡Œè§£ç ï¼Œå› ä¸ºå‰ç«¯ä¼ æ¥çš„urlæ˜¯ç»è¿‡ç¼–ç çš„
    var url = decodeURIComponent(req.body.url);
    // ç”Ÿæˆç­¾åçš„éšæœºå­—ç¬¦ä¸²
    const noncestr = "Wm3WZYTPz0wzccnW";
    // å‚ä¸ç­¾åçš„å­—æ®µåŒ…æ‹¬noncestrï¼ˆéšæœºå­—ç¬¦ä¸²ï¼‰, æœ‰æ•ˆçš„jsapi_ticket, timestampï¼ˆæ—¶é—´æˆ³ï¼‰, urlï¼ˆå½“å‰ç½‘é¡µçš„URLï¼Œä¸åŒ…å«#åŠå…¶åé¢éƒ¨åˆ†ï¼‰
    // å¯¹æ‰€æœ‰å¾…ç­¾åå‚æ•°æŒ‰ç…§å­—æ®µåçš„ASCII ç ä»å°åˆ°å¤§æ’åºï¼ˆå­—å…¸åºï¼‰åï¼Œä½¿ç”¨ URL é”®å€¼å¯¹çš„æ ¼å¼ï¼ˆå³key1=value1&key2=value2â€¦ï¼‰æ‹¼æ¥æˆå­—ç¬¦ä¸²string1
    // è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æ‰€æœ‰å‚æ•°åå‡ä¸ºå°å†™å­—ç¬¦ã€‚å¯¹string1ä½œsha1åŠ å¯†ï¼Œå­—æ®µåå’Œå­—æ®µå€¼éƒ½é‡‡ç”¨åŸå§‹å€¼ï¼Œä¸è¿›è¡ŒURL è½¬ä¹‰
    const signature = sha1(`jsapi_ticket=${ticket}&noncestr=${noncestr}&timestamp=${timestamp}&url=${url}`);

    res.send({
      appid,
      timestamp,
      noncestr,
      signature,
    });
  });

  // åˆ†äº«é¡µé¢
  router.get("/share", async (req, res) => {
    // ç½‘é¡µæˆæƒï¼Œå¾—åˆ°è®¿é—®è€…çš„openid
    let { code } = req.query;
    if (!req.session.openid) {
      var url = `https://api.weixin.qq.com/sns/oauth2/access_token?appid=${appid}&secret=${secret}&code=${code}&grant_type=authorization_code`;
      var ret = await axios.get(url);
      let { openid } = ret.data;
      req.session.openid = openid; // å­˜å‚¨openid
    }
    res.render("share", {
      openid: req.session.openid,
    });
  });

  router.get("/bargain", async (req, res) => {
    // ç½‘é¡µæˆæƒï¼Œå¾—åˆ°è®¿é—®è€…çš„openid
    let { code } = req.query;
    if (!req.session.openid) {
      var url = `https://api.weixin.qq.com/sns/oauth2/access_token?appid=${appid}&secret=${secret}&code=${code}&grant_type=authorization_code`;
      var ret = await axios.get(url);
      let { openid } = ret.data;
      req.session.openid = openid; // å­˜å‚¨openid
    }
    res.render("bargain", {
      targetOpenid: req.query.state,
      openid: req.session.openid,
    });
  });

  return router;
};

module.exports = weChatRouter;
```

- **/views/share.art**

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
</head>

<body>
  <h3>è‡ªå®šä¹‰åˆ†äº«é¡µé¢ -- ç ä»· -- {{openid}}</h3>
  <img id="img" src="" alt="">
  <button onclick="selectPic()">é€‰æ‹©å›¾ç‰‡</button>
  <script>
    var openid = '{{openid}}';

    fetch('/jsSdkConfig', {
      method: 'post',
      // ç”±äºurlä¸­æœ‰&ç¬¦å·ï¼Œæ‰€ä»¥éœ€è¦è½¬ä¹‰ï¼Œé˜²æ­¢æœ‰æ­§ä¹‰ï¼Œåç«¯è§£æé”™è¯¯
      // url=http://r7b4y4.natappfree.cc/share?code=021YaZ00011cOO12Vr300Mh3kD4YaZ0L&state=10000
      body: `url=${encodeURIComponent(location.href)}`,
      headers: {
        'content-type': 'application/x-www-form-urlencoded' // æŒ‡å®šbodyæ•°æ®ä¸ºurlæ ¼å¼(a=b&c=d)
      }
    }).then(ret => ret.json()).then(({
      appid,
      timestamp,
      noncestr,
      signature
    }) => {
      wx.config({
        debug: false,
        appId: appid, // å¿…å¡«ï¼Œå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
        timestamp: timestamp, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
        nonceStr: noncestr, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
        signature,// å¿…å¡«ï¼Œç­¾å
        // æˆæƒæƒé™åˆ—è¡¨,å°±æ˜¯å¯¹åº”çš„wx.æ–¹æ³•åç§°
        jsApiList: [
          'updateAppMessageShareData',
          'updateTimelineShareData',
          'chooseImage'
        ] // å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„ JS æ¥å£åˆ—è¡¨
      });
    })

    // configä¿¡æ¯éªŒè¯åä¼šæ‰§è¡Œ ready æ–¹æ³•ï¼Œæ‰€æœ‰æ¥å£è°ƒç”¨éƒ½å¿…é¡»åœ¨ config æ¥å£è·å¾—ç»“æœä¹‹åï¼Œconfigæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„å¼‚æ­¥æ“ä½œ
    // æ‰€ä»¥å¦‚æœéœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶å°±è°ƒç”¨ç›¸å…³æ¥å£ï¼Œåˆ™é¡»æŠŠç›¸å…³æ¥å£æ”¾åœ¨ ready å‡½æ•°ä¸­è°ƒç”¨æ¥ç¡®ä¿æ­£ç¡®æ‰§è¡Œ
    // å¯¹äºç”¨æˆ·è§¦å‘æ—¶æ‰è°ƒç”¨çš„æ¥å£ï¼Œåˆ™å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œä¸éœ€è¦æ”¾åœ¨ ready å‡½æ•°ä¸­
    wx.ready(function () {
      // è‡ªå®šä¹‰åˆ†äº«æ¶ˆæ¯(åˆ†äº«ç»™æœ‹å‹)
      wx.updateAppMessageShareData({
        title: 'å¤šå–è¿™é“å†¬ç“œæ’éª¨æ±¤', // åˆ†äº«æ ‡é¢˜
        desc: 'ä¸€åœºç§‹é›¨è¿‡åï¼Œæ°”æ¸©éª¤é™ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œä¸€åœºç§‹é›¨ï¼Œä¸€åœºå¯’â€', // åˆ†äº«æè¿°
        link: getRedirectUrl(), // åˆ†äº«é“¾æ¥ï¼Œè¯¥é“¾æ¥åŸŸåæˆ–è·¯å¾„å¿…é¡»ä¸å½“å‰é¡µé¢å¯¹åº”çš„å…¬ä¼—å· JS å®‰å…¨åŸŸåä¸€è‡´
        imgUrl: 'https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/6d79e9d09d5d4748868c106511f9fd56~noop.image?_iz=58558&from=article.pc_detail&x-expires=1667272473&x-signature=E3XidUFA1wHcRC%2F31TQ6eZOlHHw%3D', // åˆ†äº«å›¾æ ‡
        success: function () { }
      })

      // è‡ªå®šä¹‰åˆ†äº«æ¶ˆæ¯(æœ‹å‹åœˆ)
      wx.updateTimelineShareData({
        title: 'å¤šå–è¿™é“å†¬ç“œæ’éª¨æ±¤', // åˆ†äº«æ ‡é¢˜
        link: getRedirectUrl(), // åˆ†äº«é“¾æ¥ï¼Œè¯¥é“¾æ¥åŸŸåæˆ–è·¯å¾„å¿…é¡»ä¸å½“å‰é¡µé¢å¯¹åº”çš„å…¬ä¼—å· JS å®‰å…¨åŸŸåä¸€è‡´
        imgUrl: 'https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/6d79e9d09d5d4748868c106511f9fd56~noop.image?_iz=58558&from=article.pc_detail&x-expires=1667272473&x-signature=E3XidUFA1wHcRC%2F31TQ6eZOlHHw%3D', // åˆ†äº«å›¾æ ‡
        success: function () { }
      })
    });

    // configä¿¡æ¯éªŒè¯å¤±è´¥ä¼šæ‰§è¡Œ error å‡½æ•°ï¼Œå¦‚ç­¾åè¿‡æœŸå¯¼è‡´éªŒè¯å¤±è´¥ï¼Œå…·ä½“é”™è¯¯ä¿¡æ¯å¯ä»¥æ‰“å¼€ config çš„debugæ¨¡å¼æŸ¥çœ‹
    // ä¹Ÿå¯ä»¥åœ¨è¿”å›çš„ res å‚æ•°ä¸­æŸ¥çœ‹ï¼Œå¯¹äº SPA å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°ç­¾å
    wx.error(function (res) { });

    async function getRedirectUrl() {
      let ret = await fetch(`/createAuthUrl?redirect_uri=${encodeURIComponent('http://r7b4y4.natappfree.cc/bargain')}&state=${openid}`);
      let data = await ret.text()
      console.log(data)
      return data
    }

    function selectPic() {
      wx.chooseImage({
        count: 1, // å¯é€‰æ‹©å¤šå°‘å¼ å›¾ç‰‡ï¼Œé»˜è®¤9
        sizeType: ['original', 'compressed'], // å¯ä»¥æŒ‡å®šæ˜¯åŸå›¾è¿˜æ˜¯å‹ç¼©å›¾ï¼Œé»˜è®¤äºŒè€…éƒ½æœ‰
        sourceType: ['album', 'camera'], // å¯ä»¥æŒ‡å®šæ¥æºæ˜¯ç›¸å†Œè¿˜æ˜¯ç›¸æœºï¼Œé»˜è®¤äºŒè€…éƒ½æœ‰
        success: function (res) {
          // è¿”å›é€‰å®šç…§ç‰‡çš„æœ¬åœ° ID åˆ—è¡¨ï¼ŒlocalIdå¯ä»¥ä½œä¸º img æ ‡ç­¾çš„ src å±æ€§æ˜¾ç¤ºå›¾ç‰‡
          var localIds = res.localIds;
          document.getElementById('img').src = localIds
        }
      });
    }
  </script>
</body>

</html>
```

- **/views/bargain.art**

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- ç§»åŠ¨ç«¯å¼€å‘æ—¶ï¼Œæ­¤å£°æ˜ä¸€å®šè¦æœ‰ -->
  <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>æŠ•ç¥¨ä¸€ä¸‹</title>
</head>

<body>
  // åŒæ—¶è·å–ä½ çš„openidå’Œè¦ç»™ä½ ç ä»·çš„äººçš„openid
  {{targetOpenid}} <br\> {{openid}}
</body>

</html>
```

